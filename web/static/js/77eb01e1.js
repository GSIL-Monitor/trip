/**
 * Created by Administrator on 2018/2/9.
 */
// Generated by CoffeeScript 1.6.2 // www.ctrip.com，机票搜索板块js代码， //v 2017.05.18 - 3 (function () { var ChinaFlight; if (this['___ChinaFlight___'] != null) { return; } var getABTestResult = function() { for (var ret = {}, ab_testing_tracker = $("#ab_testing_tracker").value().split(";"), i = 0; i < ab_testing_tracker.length; i++) if ("" != ab_testing_tracker[i]) { var s = ab_testing_tracker[i].split(",") , _data = null; s.length > 0 && (_data = s.length >= 5 ? s[3].split(":") : s[s.length - 1].split(":")), _data && 2 == _data.length && (ret[_data[0]] = _data[1]) } return ret } var abObj = getABTestResult(); var isMultiNewVer = abObj && (abObj['170705_fld_chpad'] === 'B'); //根据AB或开关来设置值 ChinaFlight = function () { this.$$ = function (id) { return $('#FD_' + id); }; this.M$$ = function (id) { return $('#M_FD_' + id); } this.M$$2 = function (id) { return $('#M_FD_' + id + '2'); } this.searchingTxt = '\u641c\u7d22\u4e2d...'; this.searchingClass = 's_btn_ing3'; this.searchingClass2 = 's_btn_ing2'; this.config = this.$$('ChinaFlightConfig').html(); this.searchBox = $('#searchBox'); this.form = this.$$('ChinaFlightForm'); this.fltHotelForm = this.$$('ChinaFlightHotelForm'); this.airlineCode = this.$$('AirlineSelect'); this.classLevel = this.$$('ClassLevel'); this.curSearchType = 'S'; this.curAdvStyle = ''; this.returnDateDiv = this.$$('ReturnDateDiv'); this.exchangeBtn = this.form.find('div.s_exchange'); this.tranCityDiv = this.$$('TranCityDiv'); this.startDateSpan = this.$$('StartDateSpan'); this.startSearchBtn = this.$$('StartSearch'); this.startSearchTxt = this.startSearchBtn.value(); this.startSearchFltHotelBtn = this.$$('StartSearchFltHotel'); this.startSearchFltHotelTxt = this.startSearchFltHotelBtn.value(); this.advOptions = this.$$('AdvOptions'); this.advOptionsBtn = this.$$('AdvOptionsBtn'); this.HasChild = this.$$('HasChild'); this.HasBaby = this.$$('HasBaby'); if (this.config === '') { throw new Error('ChinaFlightConfig is invalid'); } try { this.config = eval('(' + this.config.replace(/\n|\r|\t/g, '') + ')'); } catch (ex) { try { this.config = eval(this.config.replace(/\n|\r|\t/g, '')); } catch (ex) { this.config = $.parseJSON(this.config.replace(/\n|\r|\t/g, '')); } } this.domain = document.domain; this.config.Domain = this.domain.split('.').slice(this.domain.indexOf('.hk') !== -1 ? -3 : -2).join('.'); this.config.Flight = this.config.Flight || ("//flights." + (this.domain.indexOf('big5.') !== -1 ? 'big5.' : '') + (this.domain.match(/(testp?|uat)/) ? RegExp.$1 + '.qa.nt.ctripcorp.com' : 'ctrip.com') + (this.domain.indexOf('.hk') !== -1 ? '.hk' : '')); //this.config.Flight 此值有些地方需要在同一场景下 跳转http，页面内使用https this.config.FlightHTTP = ("http://flights." + (this.domain.indexOf('big5.') !== -1 ? 'big5.' : '') + (this.domain.match(/(testp?|uat)/) ? RegExp.$1 + '.qa.nt.ctripcorp.com' : 'ctrip.com') + (this.domain.indexOf('.hk') !== -1 ? '.hk' : '')); this.config.Hotel = this.config.Hotel || ("http://taocan." + (this.domain.match(/(testp?|uat)/) ? RegExp.$1 + '.sh.ctriptravel.com' : 'ctrip.com') + "/freetravel/confirm"); this.cityConfig = { jsonpSource: "//webresource.c-ctrip.com/code/cquery/resource/address/flight/flight_new_poi_" + this.config.charset + ".js?releaseno=?CR_2016_03_07_22_18_26", isAutoCorrect: true }; this.cityConfig.template = this._template; //debugger; this.calendarConfig = { options: { showWeek: !0, maxDate: this.config.oneyear_today }, listeners: { onChange: function () { } } }; this.advStyle = { 'D': 'searchbox_flt_in', 'M': 'searchbox_flt_in_connect', 'H': 's_high_level_hover' }; this._autoEncode = function (o) { return o.value(); }; if (this.config.charset === 'big5') { this._autoEncode = function (o) { return o.value(); }; } this.formValidate = this.form.regMod('validate', '1.1'); this.bindEvent(); this.regCityMod(); this.regDateMod(); this.regValidateMethod(this.validates().notNull); this.regValidateMethod(this.validates().format); this.regValidateMethod(this.validates().checkCity); this.regValidateMethod(this.validates().checkDate); this.bindSubmit(); this.getStorage(); this.setDefaultLocation(); this._loadFltHotelData(); // this.setCampaign(); }; (function () { var CONFIG; CONFIG = (function () { if (cQuery.config('charset').toLowerCase() === 'big5') { return { hot: '\u71B1\u9580', nocity: '\u8A72\u57CE\u5E02\u6C92\u6709\u6A5F\u5834', nearby: '\u9130\u8FD1\u6A5F\u5834\uFF1A', addressTip: '\u652F\u6301\u4E2D\u6587/\u62FC\u97F3/\u7C21\u62FC\u8F38\u5165', addressClose: '\u00D7', addressNotFind: '\u627E\u4E0D\u5230\uFF1A' }; } return { hot: '\u70ED\u95E8', nocity: '\u8BE5\u57CE\u5E02\u6CA1\u6709\u673A\u573A', nearby: '\u90BB\u8FD1\u673A\u573A\uFF1A', addressTip: '\u652F\u6301\u4E2D\u6587/\u62FC\u97F3/\u7B80\u62FC\u8F93\u5165', addressClose: '\u00D7', addressNotFind: '\u627E\u4E0D\u5230\uFF1A' }; })(); //if (!$.browser.isIPad && !$.browser.isIPadUCWeb) { this._template = { suggestion: '\
\
' + CONFIG.addressClose + '\ ' + CONFIG.addressTip + '
\
\
\ {{enum(key) data}}\
${key}\ {{/enum}}\
\ {{enum(key,arr) data}}\ {{if key=="' + CONFIG.hot + '"}}\
\ {{each arr}}\
${display}\ {{/each}}\
\ {{else}}\
\ {{enum(subKey,subArr) arr}}\
${subKey}\
\ {{if !subArr.length>0}}\  \ {{/if}}\ {{each subArr}}\ ${display}\ {{/each}}\ \ {{/enum}}\
\ {{/if}}\ {{/enum}}\
\
', filterPageSize: 10, suggestionStyle: '.address_hot { background-color: #FFFFFF; font-size: 12px; width: 332px; padding-top:5px; border:1px solid #999; position:static }\ .address_hotcity_fd { color: #999; margin-bottom: 10px;}\ .address_hotcity_fd .close { float:right; width:20px; height:20px; margin-top:3px; text-align:center; font:bold 16px/20px Simsun; text-decoration:none; color:#666; }\ .address_hotlist { overflow: hidden; }\ .address_hot li, .address_hot_abb, .address_hot_adress { list-style: none outside none; margin: 0; padding: 0; }\ .address_hot_abb { width: 100%;height: 22px;margin-bottom: 2px;margin-top: 0;border-bottom: 2px solid #ccc;}\ .address_hot_abb li {position: relative;float: left;display: inline;margin-right: 2px;line-height: 22px;cursor: pointer;margin-bottom: -2px;}\ .address_hot_abb li span { padding: 0 8px; font-family: Verdana; }\ .address_hot_abb li .hot_selected {border-top:0;border-left:0;border-right:0;border-bottom: 2px solid #06c;font-weight: bold;color: #06c; height: 22px; display: inline-block;}\ ul.address_hot_adress { padding-top: 4px; }\ dl.address_hot_adress { padding-left:30px; padding-top: 4px; clear:both; }\ .address_hot_adress li { float: left; height: 24px; overflow: hidden; width: 67px;padding-right: 2px; }\ .address_hot_adress li a { color: #000; display: block; height: 22px; line-height: 22px; padding-left: 8px; }\ .address_hot_adress li a:hover { background-color:#2577E3; color: #FFF; text-decoration: none; }\ .address_hot_adress a { text-decoration: none; }\ .address_hot_adress dt { float:left; _display:inline; width:20px; margin-left:-25px; text-align:center; font-family:Verdana; color:#E56700; line-height:22px; }\ .address_hot_adress dd { overflow:hidden; *zoom:1;}\ .address_hot_adress dd a { width:52px; padding-left: 8px; height:22px; float:left; color:#000; line-height:22px; overflow:hidden; margin:0 2px 2px 0; }\ .address_hot_adress dd a:hover { background-color:#2577E3; color: #FFF; text-decoration: none; }', suggestionInit: function (obj) { //must be opti var spans = obj.find('span'); var uls = obj.find('dl'); var hotul = obj.find('ul'); for (var i = 0, ulsLen = uls.length; i < ulsLen; i++) { hotul.push(uls[i]); } uls = hotul; if (!spans.length) { return; } function switchTab() { var _this = this; spans.each(function (span, i) { if (span[0] == _this) { span.addClass('hot_selected'); uls[i].style.display = ''; } else { span.removeClass('hot_selected'); uls[i].style.display = 'none'; } }); obj.cover() } var w = 30; for (var i = 0, n = spans.length; i < n; i++) { w += spans[i].offsetWidth; } var t = obj.find('div').first(); if (t[0]) { t.css('width', '365px'); } spans.bind('mousedown', switchTab); switchTab.apply(spans[0]); //绑定关闭按钮 obj.find('.close').bind('mousedown', function () { addressFocusFlag = false; this.focus(); addressFocusFlag = true; }); } }; this.setCampaign = function () { var getEnvironment = function () { var currentHost = window.location.host; if (currentHost.indexOf(".dev.") > -1 || currentHost.indexOf("localhost") > -1) return "dev"; else if (currentHost.indexOf(".qa.nt.") > -1 || currentHost.indexOf("webresource.c-ctrip.com") > -1) return "fat"; else if (currentHost.indexOf(".uat.") > -1) return "uat"; else if (currentHost.indexOf(".lpt") > -1) return "lpt"; else return "pro"; }; var url = "//flights.ctrip.com/domestic/ajax/GetCampaignText"; var env = getEnvironment(); if (env == "fat") { url = "//flight.online.booking.tars.fat3.qa.nt.ctripcorp.com/domestic/ajax/GetCampaignText"; } else if (env == "uat") { url = "//flights.uat.qa.nt.ctripcorp.com/domestic/ajax/GetCampaignText"; } cQuery.jsonp(url, { charset: 'gb2312', onload: function (data) { if (data.content != null) { cQuery("#campaignText").html(data.content); cQuery("#campaignTip").html(data.tip); cQuery("#campaignContainer").css("display", "inline"); } if (data.uid && data.uid !== "") { var UBTKey = "flt_ctrip_home_online"; try { var queryStr = '{ "ABValue": ' + data.ABValue + ', "uid":"' + data.uid + '", "IsLowFrequency":"' + data.IsLowFrequency + '"}'; if (window['$_bf'] && window['$_bf'].loaded === true) { window.$_bf.tracklog(UBTKey, queryStr); } else { setTimeout(function () { if (window['$_bf'] && window['$_bf'].loaded === true) { window.$_bf.tracklog(UBTKey, queryStr); } }, 500); } } catch (ex) { cQuery.error(ex, 'sendUbtLog_bookindex'); } } } }); }; //} this.val = function (t, b, c, d) { return -c * ((t = t / d - 1) * t * t * t - 1) + b; }; this.animate = function (O, H, ori) { var CH, E, Htimer, TH, _this = this; ori = ori || 'height' E = 10; if (H != null) { TH = 0; CH = parseInt(O.css(ori), 10); if (H > CH) { H -= CH; } else { H = -(CH - H); } if (H !== 0) { Htimer = setInterval(function () { var HH; if (TH === E) { O = null; clearInterval(Htimer); return; } HH = Math.round(_this.val(TH++, CH, H, E)); O.css(ori, HH + 'px'); }, 13); } } }; this._checkForm = function (allowSubmit) { var self = this; var v, _i, _len, _ref; if (allowSubmit == null) { allowSubmit = false; } _ref = self.v_methods; for (_i = 0, _len = _ref.length; _i < _len; _i++) { v = _ref[_i]; if (!v()) { return false; } } self._setAction(); self.setStorage(); if (allowSubmit === true) { if (self.curSearchType === 'S') { this.form[0].onsubmit = function () { return true; }; // window.location = self.form.attr('action'); this.startSearchBtn.addClass(this.searchingClass); this.startSearchBtn.value(this.searchingTxt); this.startSearchFltHotelBtn.value(this.startSearchFltHotelTxt); this.startSearchFltHotelBtn.removeClass(this.searchingClass2); self.form[0].submit(); } else { window.location = self.form.attr('action'); this.startSearchBtn.addClass(this.searchingClass); this.startSearchBtn.value(this.searchingTxt); this.startSearchFltHotelBtn.value(this.startSearchFltHotelTxt); this.startSearchFltHotelBtn.removeClass(this.searchingClass2); } } return true; }; this.bindSubmit = function (e) { var _this = this; this.form[0].onsubmit = function () { return false; } this.form.bind('keypress', function (e) { if (e.keyCode == 13) { return false; } }); this.startSearchBtn.bind('click', function (e) { e.preventDefault(); this.focus(); _this._checkForm(true); }); }; this.bindEvent = function () { var _this = this; if(isMultiNewVer){ $('.J_M').find('span').css('display','') $('#searchBox>div[Flight=true]').css('background-color', 'transparent') $('.s_type_babyshow').css('padding-left', '184px'); }else{ $('.J_M').find('span').css('display','none') } $('html').bind('mousedown', function () { _this.noFocusNext = true; setTimeout(function () { _this.noFocusNext = false; }, 10); }); this.$$('flightSubSwitch input:radio').bind('click', function (e) { if (_this.curSearchType === this.value) { return; } _this.returnDateDiv.css('display', ''); _this.tranCityDiv.css('display', 'none'); _this.exchangeBtn.css('display', ''); _this.startDateSpan.html(_this.config.msg.startDate); _this.dateMods[0].attr('tabindex', 168); _this.cityMods[2].attr('tabindex', 165); _this.startSearchFltHotelBtn.css('display', ''); $('.s_type_babyshow').css('padding-left', '156px'); $('#searchBox').removeClass('searchbox_flt_out_connect'); switch (_this.curSearchType = this.value) { case 'S': if(isMultiNewVer){ $('#FD_ChinaFlightForm').find('.s_item_cont_1').css('display', '') $('#FD_ChinaFlightForm').find('.s_item_cont_3').css('display', 'none') } //_this.startSearchFltHotelBtn.css('display', ''); _this.dateMods[2].value(""); _this[_this.dateMods[2].attr('id') + '_notice'].method('checkValue'); _this.returnDateDiv.addClass("s_disable"); break; case 'D': if(isMultiNewVer){ $('#FD_ChinaFlightForm').find('.s_item_cont_1').css('display', '') $('#FD_ChinaFlightForm').find('.s_item_cont_3').css('display', 'none') } //_this.returnDateDiv.css('display', ''); //_this.startSearchFltHotelBtn.css('display', ''); _this.returnDateDiv.removeClass("s_disable"); break; case 'M': _this.startSearchFltHotelBtn.css('display', 'none'); if(isMultiNewVer){ $('.s_type_babyshow').css('padding-left', '184px'); $('#searchBox').addClass('searchbox_flt_out_connect'); $('#FD_ChinaFlightForm').find('.s_item_cont_1').css('display', 'none') $('#FD_ChinaFlightForm').find('.s_item_cont_3').css('display', '') }else{ _this.dateMods[0].attr('tabindex', 165); _this.cityMods[2].attr('tabindex', 168); _this.exchangeBtn.css('display', 'none'); _this.tranCityDiv.css('display', ''); _this.returnDateDiv.css('display', 'none'); _this.startDateSpan.html(_this.config.msg.firstDate); } } _this._autoSetSearchBoxWidth(); if (_this.curAdvStyle !== '' && _this.curAdvStyle !== _this.advStyle[_this.curSearchType === 'M' ? 'M' : 'D']) { _this._autoSetSearchBoxHeight(false); } $(_this.dateMods).each(function (d) { return _this[d[0].attr('id') + '_calendar'].method('setWeek', '#' + d[0].attr('id')); }); if (_this.curSearchType == 'D' && _this.dateMods[2].value() != '' && _this.dateMods[2].value() != _this.dateMods[2].attr('_cqnotice')) { } else { _this.setDefaultFouce(); } }); this.exchangeBtn.find('a').bind('click', function (e) { var tmp; e.preventDefault(); tmp = _this.cityMods[2].value(); if (tmp === '' && _this.cityMods[0].value() === '') { return; } _this.cityMods[2].value(_this.cityMods[0].value()); _this.cityMods[0].value(tmp); _this[_this.cityMods[0].attr('id') + '_notice'].method('checkValue'); _this[_this.cityMods[2].attr('id') + '_notice'].method('checkValue'); tmp = _this.$$(_this.cityMods[2].attr('data-target')).value(); _this.$$(_this.cityMods[2].attr('data-target')).value(_this.$$(_this.cityMods[0].attr('data-target')).value()); return _this.$$(_this.cityMods[0].attr('data-target')).value(tmp); }); this.advOptionsBtn.bind('click', function (e) { var status; e.preventDefault(); status = _this.advOptionsBtn.hasClass(_this.advStyle['H']); _this.advOptionsBtn[status ? 'removeClass' : 'addClass'](_this.advStyle['H']); _this._autoSetSearchBoxHeight(status); _this.advOptions.css('display', status ? 'none' : 'block'); }); var _this = this; window.FD_submitFltHotel = function () { if (!!(_this._checkForm(false) && _this.validates().checkHotelDate())) { var data = {}; data.FromTime = _this.dateMods[0].value(); var rd = _this.dateMods[2].value().trim(); if (rd === '') { rd = _this.dateMods[0].value().toDate().addDays(2).toFormatString('yyyy-MM-dd'); } data.ToTime = rd; data.FromCityName = _this.cityMods[0].value(); data.ToCityName = _this.cityMods[2].value(); data.FromCityCode = _this.$$(_this.cityMods[0].attr('data-target')).value().split(',')[0]; data.ToCityCode = _this.$$(_this.cityMods[2].attr('data-target')).value().split(',')[0]; data.Adults = 2; data.Children = 0; data.RoomNum = 1; data.Nights = 1; var dCityId = _this.ALLCITY[data.FromCityCode].id; var aCityId = _this.ALLCITY[data.ToCityCode].id; window.location = (_this.config.Hotel + "?from=" + dCityId + "&to=" + aCityId + "&h=" + aCityId + "&fromtime=" + data.FromTime + (data.ToTime ? ("&totime=" + data.ToTime) : "") + "&checkindate=" + data.FromTime + (data.ToTime ? ("&checkoutdate=" + data.ToTime) : "") + "&adults=" + data.Adults).toLowerCase(); //_this.updateForm(action, data, "_self"); } return false; } this.form.find('input[type=text]').bind('keydown', function (e) { if (e.keyCode === 13 ||　e.keyCode === 9) { if(e.keyCode === 13){ e.stopPropagation(); e.preventDefault(); } var target = this; _this._autoSetFocus(target.id, target.value, 'keydown', e.keyCode); return false; } }); this.form.find('.J_childBabyTip').bind('mouseover',function(){ $("#FD_FltChildBabyTip")[0].style.display="block"; }); this.form.find('.J_childBabyTip').bind('mouseout',function(){ $("#FD_FltChildBabyTip")[0].style.display="none"; }); if(isMultiNewVer){ this.form.find('.J_M').bind('mouseover',function(){ $("#J_M")[0].style.display="block"; $("#J_M")[0].style.left = "308px"; }); this.form.find('.J_M').bind('mouseout',function(){ $("#J_M")[0].style.display="none"; }); } return this.form[0].parentNode.setAttribute('Flight', true); }; this._autoSetSearchBoxWidth = function(){ if(isMultiNewVer){ this.animate($('#searchBox'), this.curSearchType === 'M' ? 870 : 580, 'width'); this.animate($('#searchBox>div[Flight=true]'), this.curSearchType === 'M' ? 755 : 451, 'width'); } } this._autoSetSearchBoxHeight = function (s) { this.curAdvStyle = s ? '' : this.advStyle[this.curSearchType === 'M' ? 'M' : 'D']; //新版首页，高度的数值又286--->300,261修改为275数据 this.animate($('#searchBox,#searchBox>ul:first'), s ? 300 : (this.curSearchType === 'M' ? 401 : 401)); this.animate($('#searchBox>div[Flight=true]'), s ? 275 : (this.curSearchType === 'M' ? 376 : 376)); // this.animate($('#searchBox,#searchBox>ul:first'), s ? 286 : (this.curSearchType === 'M' ? 401 : 401)); // this.animate($('#searchBox>div[Flight=true]'), s ? 261 : (this.curSearchType === 'M' ? 376 : 376)); }; this._loadFltHotelData = function () { var _this = this; _this.ALLCITY = {}; _this.ALLCITYNAME = {}; $.loader.jsonp("//webresource.c-ctrip.com/code/cquery/resource/address/flight/flight_new_" + cQuery.config('charset') + '.js', { async: true, onload: function (data) { data.data = data.data.replace(/@([^\|]*)\|([^\|]*)\|(\w{3})\|[^\|]*\|[^\|]*\|[^\|]*\|[^\|]*\|(\d+)/g, function (_, pingYin, cnName, code, id) { _this.ALLCITY[code] = {pingYin: pingYin, id: id, cnName: cnName}; _this.ALLCITYNAME[cnName] = code; return ""; }); } }); }; var submitForm = document.createElement("form"); document.body.appendChild(submitForm); this.updateForm = function (action, data, target) { submitForm.method = "post"; submitForm.action = action; if (target) { submitForm.target = target; } for (var key in data) { var input = $(submitForm).find('input[name=' + key + ']'); if (input.length) { input = input[0]; } else { input = document.createElement("input"); input.type = "hidden"; input.name = key; submitForm.appendChild(input); } input.value = data[key] == null ? "" : data[key]; } this.startSearchFltHotelBtn.addClass(this.searchingClass2); this.startSearchFltHotelBtn.value(this.searchingTxt); this.startSearchBtn.value(this.startSearchTxt); this.startSearchBtn.removeClass(this.searchingClass); submitForm.submit(); }; this.regCityMod = function () { var _this = this; if (this.cityModReged) { return; } this.cityMods = [this.$$('StartCity'), this.$$('TranCity'), this.$$('DestCity')]; if(isMultiNewVer){ this.cityMods.push(this.M$$('StartCity'), this.M$$('DestCity'), this.M$$2('StartCity'), this.M$$2('DestCity')) } $(this.cityMods).each(function (city) { var name = city[0].attr('id'); city[0].attr('autocomplete', 'off'); _this["" + name + "_notice"] = city[0].regMod('notice', '1.0', { name: name, tips: city[0].attr('tips') || _this.config.notice[0], selClass: 'inputSel' }); var addressConfig = { name: name, jsonpSource: _this.cityConfig.jsonpSource, template: _this.cityConfig.template, isAutoCorrect: true, jsonpFilter: '//m.ctrip.com/restapi/soa2/12812/getpoicontent?channel=1&mode=1&f=2&key=${key}' } if (city[0].attr('data-target')) { addressConfig.relate = { 3: $("#FD_" + city[0].attr('data-target')) } } ////webresource.c-ctrip.com/ResFlightOnline/R1/Booking/javascript/poi-address.js?releaseno=?CR_2015_02_11_22_18_26 $LAB.script({ src: '//webresource.c-ctrip.com/ResFlightOnline/R1/Booking/javascript/poi-address-w3home.js?openAirTrain', charset: "utf-8" }).wait(function () { _this["" + name + "_address"] = city[0].regMod('address_poi', '1.0', addressConfig); _this["" + name + "_address"].method('bind', 'change', function (e, data) { var cityData, code, v, _i, _len; if (!data.items || !data.items.name) { if(isMultiNewVer){ $('#'+this.getAttribute('data-target-name')).value(data.value); $('#'+this.getAttribute('data-target-name')).removeClass('inputSel'); } return; } if (this.oldValue === data.items.name) { } else { this.oldValue = data.items.name; code = data.items.code; if (this.oldValue.indexOf('__') !== -1) { this.value = this.oldValue.replace(/_|-/g, ''); code = _this.ALLCITYNAME[this.value]; } _this.$$(this.getAttribute('data-target')).value(code); } return _this._autoSetFocus(this.id); }); }); }); return this.cityModReged = true; }; this.regDateMod = function () { var _this = this; if (this.dateModReged) { return; } this.dateMods = [this.$$('StartDate'), this.$$('TranDate'), this.$$('ReturnDate')]; if(isMultiNewVer){ this.dateMods.push(this.M$$('StartDate'), this.M$$2('StartDate')) } this.calendarConfig.listeners.onChange = function (o, data) { if(isMultiNewVer){ $('#'+o.getAttribute('data-target-name')).value(data); $('#'+o.getAttribute('data-target-name')).removeClass('inputSel'); } if (_this.curSearchType === "S" && o.value.isDate() && o.id === _this.dateMods[2][0].id) { _this.$$('flightSubSwitch input:radio')[1].click(); } o.oldValue = o.value; _this._autoSetFocus(o.id, o.value); }; $(this.dateMods).each(function (d) { d = d[0]; d.attr('autocomplete', 'off'); _this[d.attr('id') + '_notice'] = d.regMod('notice', '1.0', { name: d.attr('id'), tips: 'yyyy-mm-dd', selClass: 'inputSel' }); var version = '3.0'; if (typeof (PluginsVersion) != 'undefined') { version = PluginsVersion.calendar; } return _this[d.attr('id') + '_calendar'] = d.regMod('calendar', version, _this.calendarConfig); }); return this.dateModReged = true; }; this._autoSetFocus = function (id, value, isKeydown, code) { var refInput = this.$$($('#'+id).attr('data-target')) setTimeout(function(){ if(!refInput.value() && value){ var mval = value.match(/[^\x00-\xff]+\((\w+)\)/) refInput.value(mval && mval[1]) } }, 50) if (this.noFocusNext) { return false; } var focusEL = null; var self = this; var submitFn = function () { setTimeout(function () { var container = $('container:first'); if (container.find('>div').length == 2 && id == 'FD_TranDate' && focusEL.id == 'FD_DestCity') { container.find('>div:last').remove(); } self.startSearchBtn.trigger('click'); }, 50) } switch (id.split('_')[1]) { case 'StartCity': focusEL = this.curSearchType === 'M' ? this.dateMods[0][0] : this.cityMods[2][0]; break; case 'TranCity': focusEL = this.dateMods[1][0]; break; case 'DestCity': if (this.curSearchType == 'M' && isKeydown && code === 13) { submitFn(); } else { focusEL = this.dateMods[0][0]; } break; case 'StartDate': this.dateMods[1].data('minDate', value); this.dateMods[2].data('minDate', value); if (this.curSearchType == 'S' && isKeydown && code === 13) { submitFn(); } else if (this.curSearchType === 'D') { focusEL = this.dateMods[2][0]; } else if (this.curSearchType === 'M') { focusEL = this.cityMods[1][0]; } break; case 'TranDate': focusEL = this.cityMods[2][0]; break; case 'ReturnDate': if (this.curSearchType == 'D' && isKeydown && code === 13) { submitFn(); } break; } try { if (focusEL && (isKeydown || focusEL.value == '' || focusEL.value == focusEL.getAttribute('_cqnotice'))) { setTimeout(function () { var container = $('container:first'); if (container.find('>div').length == 2 && id == 'FD_TranDate' && focusEL.id == 'FD_DestCity') { container.find('>div:last').remove(); } focusEL.focus(); }, 50); } } catch (e) { } }; this.validates = function () { var _this = this; return { notNull: function () { if (_this[_this.cityMods[0].attr('id') + '_notice'].method('isEmpty')) { _this.validateShow(_this.cityMods[0], _this.config.tip.chinaFlight[2]); return false; } if (_this.curSearchType !== 'M' && _this[_this.cityMods[2].attr('id') + '_notice'].method('isEmpty')) { _this.validateShow(_this.cityMods[2], _this.config.tip.chinaFlight[3]); return false; } if (!(isMultiNewVer && _this.curSearchType === 'M') && _this[_this.dateMods[0].attr('id') + '_notice'].method('isEmpty')) { _this.validateShow(_this.dateMods[0], _this.config.tip.chinaFlight[_this.curSearchType === 'M' ? 17 : 5]); return false; } if (_this.curSearchType === 'M') { if(!isMultiNewVer){ if (_this[_this.cityMods[1].attr('id') + '_notice'].method('isEmpty')) { _this.validateShow(_this.cityMods[1], _this.config.tip.chinaFlight[10]); return false; } if (_this[_this.dateMods[1].attr('id') + '_notice'].method('isEmpty')) { _this.validateShow(_this.dateMods[1], _this.config.tip.chinaFlight[11]); return false; } if (_this[_this.cityMods[2].attr('id') + '_notice'].method('isEmpty')) { _this.validateShow(_this.cityMods[2], _this.config.tip.chinaFlight[3]); return false; } }else{ if (_this[_this.cityMods[3].attr('id') + '_notice'].method('isEmpty')) { _this.validateShow(_this.cityMods[3], _this.config.tip.chinaFlight[2]); return false; } if (_this[_this.cityMods[4].attr('id') + '_notice'].method('isEmpty')) { _this.validateShow(_this.cityMods[4], _this.config.tip.chinaFlight[3]); return false; } if (_this[_this.dateMods[3].attr('id') + '_notice'].method('isEmpty')) { _this.validateShow(_this.dateMods[3], _this.config.tip.chinaFlight[17]); return false; } if (_this[_this.cityMods[5].attr('id') + '_notice'].method('isEmpty')) { _this.validateShow(_this.cityMods[5], _this.config.tip.chinaFlight[2]); return false; } if (_this[_this.cityMods[6].attr('id') + '_notice'].method('isEmpty')) { _this.validateShow(_this.cityMods[6], _this.config.tip.chinaFlight[3]); return false; } if (_this[_this.dateMods[4].attr('id') + '_notice'].method('isEmpty')) { _this.validateShow(_this.dateMods[4], _this.config.tip.chinaFlight[11]); return false; } } } return true; }, format: function () { if (!(isMultiNewVer && _this.curSearchType === 'M') && !_this.dateMods[0].value().trim().isDate()) { _this.validateShow(_this.dateMods[0], _this.config.tip.chinaFlight[_this.curSearchType === 'M' ? 16 : 0]); return false; } if(!isMultiNewVer){ if (_this.curSearchType === 'M' && !_this.dateMods[1].value().trim().isDate()) { _this.validateShow(_this.dateMods[1], _this.config.tip.chinaFlight[12]); return false; } }else{ if (_this.curSearchType === 'M' && !_this.dateMods[3].value().trim().isDate()) { _this.validateShow(_this.dateMods[3], _this.config.tip.chinaFlight[16]); return false; } if (_this.curSearchType === 'M' && !_this.dateMods[4].value().trim().isDate()) { _this.validateShow(_this.dateMods[4], _this.config.tip.chinaFlight[12]); return false; } } if (_this.curSearchType === 'D' && _this.dateMods[2].value().trim() !== '' && !_this.dateMods[2].value().trim().isDate()) { _this.validateShow(_this.dateMods[2], _this.config.tip.chinaFlight[1]); return false; } return true; }, checkCity: function () { if (_this.curSearchType !== 'M') { if (_this.cityMods[0].value() == _this.cityMods[2].value() || (_this.$$(_this.cityMods[0].attr('data-target')).value() && _this.$$(_this.cityMods[2].attr('data-target')).value() && _this.$$(_this.cityMods[0].attr('data-target')).value().split(',')[0] == _this.$$(_this.cityMods[2].attr('data-target')).value().split(',')[0])) { _this.validateShow(_this.cityMods[2], _this.config.tip.chinaFlight[4]); return false; } } else if(!isMultiNewVer){ if (_this.cityMods[0].value() === _this.cityMods[1].value() || _this.$$(_this.cityMods[0].attr('data-target')).value().split(',')[0] == _this.$$(_this.cityMods[1].attr('data-target')).value().split(',')[0]) { _this.validateShow(_this.cityMods[1], _this.config.tip.chinaFlight[13]); return false; } if (_this.cityMods[1].value() === _this.cityMods[2].value() || _this.$$(_this.cityMods[1].attr('data-target')).value().split(',')[0] == _this.$$(_this.cityMods[2].attr('data-target')).value().split(',')[0]) { _this.validateShow(_this.cityMods[2], _this.config.tip.chinaFlight[14]); return false; } }else{ if (_this.cityMods[3].value() === _this.cityMods[4].value()) { _this.validateShow(_this.cityMods[3], _this.config.tip.chinaFlight[4]); return false; } if (_this.cityMods[5].value() === _this.cityMods[6].value()) { _this.validateShow(_this.cityMods[5], _this.config.tip.chinaFlight[4]); return false; } } return true; }, checkDate: function () { if(isMultiNewVer){ if (_this.curSearchType === 'M') { if (_this.dateMods[4].value().toDate() < _this.dateMods[3].value().toDate()) { _this.validateShow(_this.dateMods[4], _this.config.tip.chinaFlight[15].replace('{$startDate}', _this.dateMods[3].value())); return false; } if (_this.dateMods[4].value().toDate() > _this.config.oneyear_today.toDate()) { _this.validateShow(_this.dateMods[4], _this.config.tip.chinaFlight[9]); return false; } } return true } if (_this.dateMods[0].value().toDate() < _this.config.today.toDate()) { _this.validateShow(_this.dateMods[0], _this.config.tip.chinaFlight[7].replace('{$today}', _this.config.today)); return false; } if (_this.dateMods[0].value().toDate() > _this.config.oneyear_today.toDate()) { _this.validateShow(_this.dateMods[0], _this.config.tip.chinaFlight[9]); return false; } if (_this.curSearchType === 'D' && _this.dateMods[2].value().trim() !== '') { if (_this.dateMods[2].value().toDate() < _this.dateMods[0].value().toDate()) { _this.validateShow(_this.dateMods[2], _this.config.tip.chinaFlight[8].replace('{$startDate}', _this.dateMods[0].value())); return false; } if (_this.dateMods[2].value().toDate() > _this.config.oneyear_today.toDate()) { _this.validateShow(_this.dateMods[2], _this.config.tip.chinaFlight[9]); return false; } } if (_this.curSearchType === 'M') { if (_this.dateMods[1].value().toDate() < _this.dateMods[0].value().toDate()) { _this.validateShow(_this.dateMods[1], _this.config.tip.chinaFlight[15].replace('{$startDate}', _this.dateMods[0].value())); return false; } if (_this.dateMods[1].value().toDate() > _this.config.oneyear_today.toDate()) { _this.validateShow(_this.dateMods[1], _this.config.tip.chinaFlight[9]); return false; } } return true; }, checkHotelDate: function () { if (_this.dateMods[0].value().toDate() < (new Date()).addDays(1).toDate()) { _this.validateShow(_this.dateMods[0], _this.config.tip.chinaFlight[18]); return false; } if (_this.curSearchType === 'D') { if (_this.dateMods[2].value().toDate() < _this.dateMods[0].value().toDate().addDays(1)) { _this.validateShow(_this.dateMods[2], _this.config.tip.chinaFlight[19]); return false; } if (_this.dateMods[2].value().toDate() > _this.dateMods[0].value().toDate().addDays(28)) { _this.validateShow(_this.dateMods[2], _this.config.tip.chinaFlight[20]); return false; } } return true; } }; }; this._toUrlString = function (o) { var k, ret, v; ret = []; for (k in o) { v = o[k]; if (o.hasOwnProperty(k) && v !== '') { ret.push("" + k + "=" + v); } } return ret.join('&'); }; this._getPublicParams = function () { var params; params = !(isMultiNewVer && this.curSearchType === 'M') ? { DDate1: this.dateMods[0].value(), DDate2: this.dateMods[this.curSearchType === 'M' ? 1 : 2].value(), DCityName1: this._autoEncode(this.cityMods[0]), ACityName1: this._autoEncode(this.cityMods[this.curSearchType === 'M' ? 1 : 2]) } : { DDate1: this.dateMods[3].value(), DDate2: this.dateMods[4].value(), DCityName1: this._autoEncode(this.cityMods[3]), ACityName1: this._autoEncode(this.cityMods[4]) }; if (this.curSearchType === 'M') { if(!isMultiNewVer){ params['ACity2'] = this.$$('ACity1').value(); params['ACityName2'] = this._autoEncode(this.cityMods[2]); }else{ /*params['DCity2'] = this.$$('ACity1').value(); params['DCityName2'] = this._autoEncode(this.cityMods[2]); params['ACity2'] = this.$$('ACity1').value(); params['ACityName2'] = this._autoEncode(this.cityMods[2]); */ } } if (this.HasChild[0].checked) { params['HasChild'] = "T"; } if (this.HasBaby[0].checked) { params['HasBaby'] = "T"; } /* if(this.curSearchType !== 'M'){ if(this.airlineCode.value()){ params['SEOAirlineDibitCode'] = this.airlineCode.value(); } if(this.classLevel.value()){ params['ClassType'] = this.classLevel.value(); } } */ return this._toUrlString(params); }; this._setAction = function () { var url; if(!(isMultiNewVer && this.curSearchType === 'M')){ $('#FD_DCity2').length && $('#FD_DCity2').value(""); $('#FD_ACity2').length && $('#FD_ACity2').value(""); $('#M_FD_StartDate2').length && $('#M_FD_StartDate2').value(""); if (this.$$('DCity1').value() === '' || this.$$('ACity1').value() === '') { this.form.attr('action', this.config.FlightHTTP + ("/Domestic/Search/FirstRoute/?" + (this._getPublicParams()))); return; } if (this.curSearchType === 'S' || (this.curSearchType === 'D' && this.dateMods[2].value() === '')) { this.curSearchType = 'S'; url=this.config.FlightHTTP + ("/booking/" + (this.$$('DCity1').value()) + "-" + (this.$$('ACity1').value()) + "-day-1.html?DDate1=" + this.dateMods[0].value()) if (this.HasChild[0].checked) { url+="&HasChild=T"; } if (this.HasBaby[0].checked) { url+="&HasBaby=T"; } this.form.attr('action',url ); return; } url = { Dayoffset: Math.floor((this.dateMods[0].value().toDate().getTime() - new Date().getTime()) / (1000 * 60 * 60 * 24)) + 1 }; }else{ url = { dcity2: $('#FD_DCity2').value(), acity2: $('#FD_ACity2').value() } } var acity1 = this.curSearchType === 'M' && !isMultiNewVer ? this.$$('TransitCity').value() : this.$$('ACity1').value() var urlstr = "/booking/" + this.$$('DCity1').value() + "-" + acity1 + "-" + (this.classLevel.value()) + "-" + (this.airlineCode.value()) + "-" + this.curSearchType + "-adu-1/?" + (this._toUrlString(url)) + "&" + this._getPublicParams(); this.form.attr('action', this.config.FlightHTTP + urlstr); }; this.setStorage = function () { var cfConfig, prefix, fdArr; cfConfig = { FlightType: this.curSearchType, StartCity: this.cityMods[0].value(), DCity1: this.$$('DCity1').value(), TranCity: this.cityMods[1].value(), TransitCity: this.$$('TransitCity').value(), DestCity: this.cityMods[2].value(), ACity1: this.$$('ACity1').value(), StartDate: this.dateMods[0].value(), TranDate: this.dateMods[1].value(), ReturnDate: this.dateMods[2].value(), AirlineSelect: this.airlineCode.value(), ClassLevel: this.classLevel.value(), AdvStyle: this.curAdvStyle }; if(isMultiNewVer&&this.curSearchType==='M'){ cfConfig.StartCity2 = this.cityMods[5].value(), cfConfig.DCity2 = this.$$('DCity2').value(), cfConfig.DestCity2 = this.cityMods[6].value(), cfConfig.ACity2 = this.$$('ACity2').value(), cfConfig.StartDate = this.dateMods[3].value(), cfConfig.StartDate2 = this.dateMods[4].value() fdArr = [cfConfig.FlightType, cfConfig.StartCity, cfConfig.DCity1, cfConfig.StartDate, cfConfig.DestCity, cfConfig.ACity1, cfConfig.StartDate2, cfConfig.DestCity2, cfConfig.ACity2, cfConfig.StartCity2, cfConfig.DCity2] }else{ fdArr = [cfConfig.FlightType, cfConfig.StartCity, cfConfig.DCity1, cfConfig.StartDate, cfConfig.DestCity, cfConfig.ACity1, cfConfig.FlightType === 'M' ? cfConfig.TranDate : cfConfig.ReturnDate, cfConfig.TranCity, cfConfig.TransitCity] } var FD_SearchHistorty = { type: cfConfig.FlightType, data: escape(fdArr.join('$')) } return this.setCookie('FD_SearchHistorty', cQuery.stringifyJSON(FD_SearchHistorty)); }; this.setDefaultLocation = function (ip) { var _this = this; if (this.cityMods[0].value() === '') { return $.loader.jsonp(this.config.Flight + "/Domestic/API/GetNameByIP", { async: true, onload: function (ret) { _this.cityMods[0].value(ret.data.Name); _this[_this.cityMods[0].attr('id') + '_notice'].method('checkValue'); return _this.$$(_this.cityMods[0].attr('data-target')).value(ret.data.Code); } }); } }; this.getStorage = function () { var cType, data, i, prefix, tId, v, _i, _len, _this = this; prefix = this.config.charset === 'big5' ? 'B' : ''; var FD_SearchHistorty = this.getCookie('FD_SearchHistorty'); // FD_SearchHistorty = '{"type":"M","data":"M$北京(BJS)$BJS$2017-07-19$上海(SHA)$SHA$2017-07-22$武汉(WUH)$WUH$杭州(HGH)$HGH"}' FD_SearchHistorty = FD_SearchHistorty ? cQuery.parseJSON(FD_SearchHistorty) : {}; cType = FD_SearchHistorty.type; $(this.cityMods).each(function (city) { city[0][0].value = ''; }); $(this.dateMods).each(function (d) { d[0][0].value = ''; }); if (cType != null) { this.$$("flightSubSwitch input:radio[MM=" + cType + "]").trigger('click')[0].checked = true; data = FD_SearchHistorty.data.split('$'); var today = new Date().toStdDateString().toDate().getTime(); if(isMultiNewVer){ if (data != null) { tId = ['StartCity', 'DCity1', 'StartDate', 'DestCity', 'ACity1', cType === 'M' ? 'StartDate2' : 'ReturnDate', 'DestCity2', 'ACity2', 'StartCity2', 'DCity2']; data.shift(); for (i = _i = 0, _len = data.length; _i < _len; i = ++_i) { v = data[i]; if (v !== '') { if (tId[i] == 'ReturnDate' && cType == 'S') { v = ''; } if (tId[i] == 'StartDate' && v.toDate().getTime() < today) { this.$$(tId[i]).value(''); this.$$(tId[i]).trigger('blur'); this.M$$(tId[i]).value(''); this.M$$(tId[i]).trigger('blur'); } else if ((tId[i] == 'ReturnDate' || tId[i] == "StartDate2") && (v.toDate().getTime() < today || data[2].toDate().getTime() > v.toDate().getTime())) { this.$$(tId[i]).value(''); this.$$(tId[i]).trigger('blur'); this.M$$(tId[i]).value(''); this.M$$(tId[i]).trigger('blur'); } else { if ((i == 0 || i == 3 || i == 6)) { if (data[i + 1]) { this.$$(tId[i]).value(v); this.$$(tId[i + 1]).value(data[i + 1]); this.M$$(tId[i]).value(v); this.M$$(tId[i + 1]).value(data[i + 1]); } } else { this.$$(tId[i]).value(v); this.$$(tId[i + 1]).value(data[i + 1]); this.M$$(tId[i]).value(v); this.M$$(tId[i + 1]).value(data[i + 1]); } } } } } }else{ if (data != null) { tId = ['StartCity', 'DCity1', 'StartDate', 'DestCity', 'ACity1', cType === 'M' ? 'TranDate' : 'ReturnDate', 'TranCity', 'TransitCity']; data.shift(); for (i = _i = 0, _len = data.length; _i < _len; i = ++_i) { v = data[i]; if (v !== '') { if (tId[i] == 'ReturnDate' && cType == 'S') { v = ''; } if (tId[i] == 'StartDate' && v.toDate().getTime() < today) { this.$$(tId[i]).value(''); this.$$(tId[i]).trigger('blur'); } else if ((tId[i] == 'ReturnDate' || tId[i] == "TranDate") && (v.toDate().getTime() < today || data[2].toDate().getTime() > v.toDate().getTime())) { this.$$(tId[i]).value(''); this.$$(tId[i]).trigger('blur'); } else { //0：StartCity，3：DestCity，6：TranCity //['StartCity', 'DCity1', 'StartDate', 'DestCity', 'ACity1', cType === 'M' ? 'TranDate' : 'ReturnDate', 'TranCity', 'TransitCity']; if ((i == 0 || i == 3 || i == 6)) { if (data[i + 1]) { this.$$(tId[i]).value(v); this.$$(tId[i + 1]).value(data[i + 1]); this.$$(tId[i])[0].oldValue = v; } } else { this.$$(tId[i]).value(v); this.$$(tId[i + 1]).value(data[i + 1]); this.$$(tId[i])[0].oldValue = v; } } } } } } } $(this.cityMods).each(function (city) { _this[city[0].attr('id') + '_notice'].method('checkValue'); }); $(this.dateMods).each(function (d) { _this[d[0].attr('id') + '_notice'].method('checkValue'); }); if (this.dateMods[0].value() !== '') { this.dateMods[1].data('minDate', this.dateMods[0].value()); this.dateMods[2].data('minDate', this.dateMods[0].value()); } }; this.validateShow = function (obj, message) { var self = this; setTimeout(function () { self.formValidate.method('show', { $obj: obj, data: message, removeErrorClass: true, hideEvent: 'blur', isFocus: true }); }, 30); }; this.regValidateMethod = function (f) { return this.v_methods.push(f); }; this.v_methods = []; this.setCookie = function (name, val) { var exp; exp = new Date(); exp.setTime(exp.getTime() + 2592000000); return document.cookie = name + ("=" + val + "; expires=" + (exp.toGMTString()) + "; path=/; domain=" + this.config.Domain); }; this.getCookie = function (name) { var arr; arr = document.cookie.match(new RegExp("(?:^|;)\\s*" + name + "=([^;]+)")); if (arr) { return unescape(arr[1]); } return null; }; this.setDefaultFouce = function () { (!$.browser.isIPad && !$.browser.isIPadUCWeb) && setTimeout(function () { if(this['___ChinaFlight___'] && this['___ChinaFlight___']["FD_StartCity_address"]){ this['___ChinaFlight___']["FD_StartCity_address"].method('focus', { isHidden: true, isSelected: true }); } }, 200); }; return this; }).call(ChinaFlight.prototype); this['___ChinaFlight___'] = new ChinaFlight; var self = this; setTimeout(function () { self['___ChinaFlight___'].setDefaultFouce(); }, 200); }).call(this); function chinaFlightSF() { window['___ChinaFlight___'].setDefaultFouce(); }/*****$endoflist$*****/