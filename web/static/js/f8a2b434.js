/**
 * Created by Administrator on 2018/2/9.
 */
/* 全站首页-海外酒店搜索框 20150714*/ ; (function (win, $) { win.IntlSearchVersion = '2015-02-03 IE7 fix'; win.InteMod = {}; //展示tips $.fn.showTips = function(options){ var tipsEle = options.tipsEle, $thisTipsEle, preventDisappearEle = options.preventDisappearEle, disabledClass = options.disabledClass, openArrow = options.openArrow, closeArrow = options.closeArrow, fnBrforeDisplayTipEle = options.fnBrforeDisplayTipEle, callback = options.callback, delayDisappearTime = options.delayDisappearTime || 200, isNeedDispearTipsManually = options.isNeedDispearTipsManually; var delayDisappear; var $thisHoverEle = this; /*function openArrowDefault(){ if(openArrowClass && closeArrowClass) $thisHoverEle.removeClass(closeArrowClass).addClass(openArrowClass); }; function closeArrowDefault(){ if(openArrowClass && closeArrowClass) $thisHoverEle.removeClass(openArrowClass).addClass(closeArrowClass); };*/ function _preventDisappearEleRegister(){ $(preventDisappearEle).bind('mouseover', function(e){ $(preventDisappearEle).attr('data-regisAlready', 'true'); clearTimeout(delayDisappear); }); if(isNeedDispearTipsManually){ $(preventDisappearEle).bind('mouseout', function(){ $thisHoverEle.trigger('mouseout'); }); }; }; function bindEventForIpad(){ //pad端 $thisHoverEle.bind('touchstart', function(e){ e.stop(); if(fnBrforeDisplayTipEle) fnBrforeDisplayTipEle($thisHoverEle, e); if(tipsEle) $(tipsEle).removeClass('hidden'); //前提：tips的width要事先算好 openArrow && typeof openArrow === 'function' && openArrow($thisHoverEle, e); }); $('body').bind('touchstart', function(e){ if(tipsEle) $(tipsEle).addClass('hidden'); closeArrow && typeof closeArrow === 'function' && closeArrow($thisHoverEle, e); }); }; function bindEventForPC(){ //pc端 $thisHoverEle.bind('mouseover', function(e){ if(disabledClass && $thisHoverEle.hasClass(disabledClass)) return; clearTimeout(delayDisappear); callback && typeof callback === 'function' && callback($thisHoverEle, e); if(fnBrforeDisplayTipEle) $thisTipsEle = fnBrforeDisplayTipEle($thisHoverEle, e); if(tipsEle) $(tipsEle).removeClass('hidden'); //前提：tips的width要事先算好 openArrow && typeof openArrow === 'function' && openArrow($thisHoverEle, e, $thisTipsEle); if(preventDisappearEle && !$(preventDisappearEle).attr('data-regisAlready')) _preventDisappearEleRegister(); }); $thisHoverEle.bind('mouseout', function(e){ delayDisappear = setTimeout(function(){ //console.log('close!!') if(tipsEle) $(tipsEle).addClass('hidden'); closeArrow && typeof closeArrow === 'function' && closeArrow($thisHoverEle, e, $thisTipsEle); },delayDisappearTime); }); if(preventDisappearEle) _preventDisappearEleRegister(); }; function _initBindEvent(){ if($thisHoverEle.attr('data-registerAlready')) return; $thisHoverEle.attr('data-registerAlready', 'true'); if($.browser.isIPad){ bindEventForIpad(); } else{ bindEventForPC(); } }; _initBindEvent(); }; $.fn.on = function(eventType, targetEle, fn){ var $thisEle = this, eventType = eventType.trim(); if(eventType.indexOf(',') == -1){ eventRegister(eventType); } else{ var eventTypeArr = eventType.split(','); for(var i = 0; i < eventTypeArr.length; i++){ eventRegister(eventTypeArr[i]); }; }; function eventRegister(eventType){ $thisEle.bind(eventType, function(e){ e = e || window.event; var target = e.target || e.srcElement, $targetEles = $thisEle.find(targetEle); for(var index = 0; index < $targetEles.length; index++){ if(($(target)[0] == $targetEles.eq(index)[0]) || ($(target).parents($targetEles.eq(index)[0]).length && (target = $(target).parents($targetEles.eq(index)[0])))){ fn($(target), e); break; }; }; }); //for trigger $thisEle.bind('fakeEvent_' + eventType, function(e, opt){ //最前面的e勿漏！！ direction,degrees:传递的参数 fn($(opt.thisEleStr), e); }); }; }; $.fn.parents = function(parentNodes){ var $thisEleArr = this, ret = [], newRet = [], $parentNodes = $(parentNodes); $thisEleArr.each(function($thisEle){ ret.push(checkTargetParentNode($thisEle)); }); function checkTargetParentNode($thisEle){ function matchParentNode(){ var isMatchParentNode = false; $parentNodes.each(function($thisParentNode){ if($thisEle[0] == $thisParentNode[0]){ isMatchParentNode = true; }; }); return isMatchParentNode; }; while(!matchParentNode()){ $thisEle = $thisEle.parentNode(); if(!$thisEle[0] || $thisEle[0].tagName == 'BODY'){ break; //return thisEle => $('body') }; }; return $thisEle[0]; }; for(var z = 0; z < ret.length; z++){ if(ret[z] && ret[z].tagName != 'BODY') newRet.push(ret[z]); }; return $(newRet); }; $.fn.eq = function(n){ if(this.length){ return $(this.get(n)); } else{ return this; }; }; function htmlToDom(html, win) { var div = win ? win.document.createElement('div') : document.createElement('div'), fragment = document.createDocumentFragment(); div.innerHTML = html; var children = div.children; if (children.length > 1) { while (children.length > 0) { fragment.appendChild(children[0]); } return $(fragment); } else { return $(children[0]); } }; var initPersonSearch = function () { var _self = this; (function(){ var $Quantity = $('#inteHotelForm #roomQuantity'), $display_quantity = $('#inteHotelForm #inteRoomsQuantity'), $roomQuantityTpl = $('#inteHotelForm #J_RoomQuantitySelectorTpl'), $QuantitySelectorBox = $('#inteHotelForm .J_quantitySelectorBox'), $J_quantityBox = $('#inteHotelForm .J_quantityBox'), $display_quantity_clickNode = $('#inteHotelForm #inteRoomsQuantity, .J_quantityBox i'), $J_cildNumSelectorBox = $("#inteHotelForm .J_cildNumSelectorBox"), roomQuantity = parseInt($Quantity.value()) || 1; $display_quantity.value(roomQuantity + '间'); $QuantitySelectorBox.html($.tmpl.render($roomQuantityTpl.html())); //html()之后才有J_RoomQuantitySelector var $J_RoomQuantitySelector = $('#inteHotelForm .J_RoomQuantitySelector li'); $display_quantity_clickNode.bind('click', function (e) { //与住客数浮层互斥 $J_cildNumSelectorBox.addClass("hidden"); var $thisJ_quantitySelectorBox = $(this).parents('.J_quantityBox').find('.J_quantitySelectorBox'); if($thisJ_quantitySelectorBox.hasClass('hidden')){ $thisJ_quantitySelectorBox.removeClass('hidden'); $J_quantityBox.addClass('n_gst38578_active'); }else{ $thisJ_quantitySelectorBox.addClass('hidden'); $J_quantityBox.removeClass('n_gst38578_active'); } }); $J_RoomQuantitySelector.bind('click', function (e) { roomQuantity = $(this).attr('data-value'); $display_quantity.value(roomQuantity + '间'); $Quantity.value(roomQuantity); $QuantitySelectorBox.each(function(item){ item.addClass('hidden'); }); }); })(); var $J_cildNumSelectorBox = $('#inteHotelForm .J_cildNumSelectorBox'), $J_quantitySelectorBox = $('#inteHotelForm .J_quantitySelectorBox'), $J_cildNumBox = $('#inteHotelForm .J_cildNumBox'), $J_cildNumBoxArrow = $('#inteHotelForm .J_cildNumBox i.n_gst_tri'), $J_quantityBox = $('#inteHotelForm .J_quantityBox'), $J_cildNumBoxJ_quantityBox = $('#inteHotelForm .J_cildNumBox, .J_quantityBox'), $J_cildAdultNumSelectorTplB = $('#inteHotelForm #J_cildAdultNumSelectorTplB'), $J_cildAgeSelectorTplB = $('#inteHotelForm #J_cildAgeSelectorTplB'), divChildStr = '#inteHotelForm #divChild', J_default_child_tips_str = '#inteHotelForm .J_default_child_tips', J_adult_number_str = '#inteHotelForm .J_adult_number', J_child_number_str = '#inteHotelForm .J_child_number', J_number_adult_plus_str = '#inteHotelForm .J_number_adult_plus', J_number_adult_minus_str = '#inteHotelForm .J_number_adult_minus', J_number_child_plus_str = '#inteHotelForm .J_number_child_plus', J_number_child_minus_str = '#inteHotelForm .J_number_child_minus', divChildSelect_str = '#inteHotelForm #divChild select', dtChildYear_str = '#inteHotelForm #dtChildYear', inteHotelFormChildstr ='#inteHotelForm #child'; if ($('#childNum').length == 0) return; var childAgeCache = [-1,-1,-1,-1,-1,-1,-1,-1,-1]; function parseChildAgeCacheVal(cacheNoConfirmChildNum){ if(!cacheNoConfirmChildNum){ var childNum = $('#childNum').value(); if(childNum.indexOf('-') != -1){ var childNumArr = childNum.split('-'); childNumArr.splice(0,1); for(var i = 0, iLen = childAgeCache.length; i < iLen; i++){ if(childNumArr[i] && childNumArr[i] != childAgeCache[i]) childAgeCache[i] = childNumArr[i]; }; }; } else{ var $options = $(divChildSelect_str); for(var i = 0, iLen = childAgeCache.length; i < iLen; i++){ if($options.eq(i).length && $options.eq(i).value() != childAgeCache[i]) childAgeCache[i] = $options.eq(i).value(); }; }; } function getChildAgeSelectedVal(childCount){ var ageList = []; for(var i = 0; i < childCount; i++){ ageList.push(childAgeCache[i]); }; return ageList; } function personSearchbindEvents(){ var _self = this; $J_cildNumBoxJ_quantityBox.bind('click', function(e){ e.stop(); }); $('body, .J_close').bind('click', function(){ $J_cildNumSelectorBox.addClass('hidden'); $J_quantitySelectorBox.addClass('hidden'); $J_cildNumBox.removeClass('n_gst38578_active'); $J_quantityBox.removeClass('n_gst38578_active'); $(J_default_child_tips_str).addClass('hidden'); }); }; function showChildSelectDialog(childNum) { var cn = childNum.split('-'); var audltCount = parseInt(cn[0]); audltCount = audltCount > 36 ? 2 : audltCount; var childCount = 0; $('#inteRooms').value(audltCount); $(divChildStr).css('display', 'none'); if (cn.length > 1) { $(divChildStr).css('display', ''); for (var i = 1; i < (cn.length > 9 ? 9 : cn.length) ; i++) { childCount++; $(inteHotelFormChildstr + i).css('display', ''); $(inteHotelFormChildstr + i).find('select').value(cn[i]); } } return {audltCount: audltCount, childCount: childCount}; } function BuildOption(audltCount, childCount, redraw) { var selOtherNum = ''; if (audltCount == 1 && childCount == 0) { $('#childNum').value('1'); $('#inteRooms').value('1成人'); } else if (audltCount == 2 && childCount == 0) { $('#childNum').value('2'); $('#inteRooms').value('2成人'); } else{ selOtherNum = audltCount + "成人" + " " + (childCount > 0 ? childCount + "儿童" : ""); $('#inteRooms').value(selOtherNum); }; $('#inteRooms').attr('data-val', audltCount); parseChildAgeCacheVal(); var childAgeSelectedList = getChildAgeSelectedVal(childCount); var checkIn = $('#inteCheckIn').value().toDate() || new Date().addDays(1); var today = checkIn.getFullYear() + '年' + (checkIn.getMonth() + 1) + '月' + checkIn.getDate() + '日'; if(redraw){ $J_cildNumSelectorBox.html($.tmpl.render($J_cildAdultNumSelectorTplB.html(), {audltCount: audltCount, childCount: childCount})); $(divChildStr).removeClass('hidden').html($.tmpl.render($J_cildAgeSelectorTplB.html(), {today: today, childNum: childCount, childAgeSelectedList: childAgeSelectedList})); } } var childNum = $('#childNum').value(); if (childNum) { var r = showChildSelectDialog(childNum); BuildOption(r.audltCount, r.childCount, true); personSearchbindEvents(); if (!$('#inteRooms').value()) { $('#inteRooms').value(1 + '成人'); } $('#inteRooms').bind('click', function () { //与间数浮层互斥 $J_quantitySelectorBox.addClass("hidden"); var $thisJ_cildNumSelectorBox = $(this).parents('.J_cildNumBox').find('.J_cildNumSelectorBox'); var $thisParentsJ_cildNumBox = $(this).parents('.J_cildNumBox'); $thisParentsJ_cildNumBox.find('.J_cildNumSelectorBox').removeClass('hidden'); var checkIn = $('#inteCheckIn').value().toDate() || new Date().addDays(1); var today = '儿童年龄（' + checkIn.getFullYear() + '年' + (checkIn.getMonth() + 1) + '月' + checkIn.getDate() + '日当天）'; var childYear = $(dtChildYear_str); childYear.text(today); $thisParentsJ_cildNumBox.addClass('n_gst38578_active'); }); $J_cildNumBoxArrow.bind('click', function(){ $(this).parents('.J_cildNumBox').find('input.n_gst_v').trigger('click'); }); $J_cildNumSelectorBox.on(!$.browser.isIPad ? 'click' : 'change', '#divChild select', function () { parseChildAgeCacheVal(true); }); $J_cildNumSelectorBox.on('click', '.J_fastSelectList', function ($thisEle) { $('#inteRooms').value($thisEle.html()); $J_cildNumSelectorBox.addClass('hidden'); $('#childNum').value($thisEle.attr('data-childNumVal')); $J_cildNumBox.removeClass('n_gst_active'); }); $J_cildNumSelectorBox.on('click', '.J_number_adult_plus', function ($thisEle) { var adultNumberDom = $(J_adult_number_str); var adultNum = parseInt(adultNumberDom.value()) || 2; if(adultNum >= 35){ if(adultNum >= 36){ return; } $(J_number_adult_plus_str).addClass('number_disable'); } if(adultNum >=1 ){ $(J_number_adult_minus_str).removeClass('number_disable'); } adultNumberDom.value( adultNum + 1); }); $J_cildNumSelectorBox.on('click', '.J_number_adult_minus', function ($thisEle) { var adultNumberDom = $(J_adult_number_str); var adultNum = parseInt(adultNumberDom.value()) || 2; if(adultNum <= 2){ if(adultNum <= 1){ return; } $(J_number_adult_minus_str).addClass('number_disable'); } if(adultNum <=36 ){ $(J_number_adult_plus_str).removeClass('number_disable'); } adultNumberDom.value( adultNum - 1); }); $J_cildNumSelectorBox.on('click', '.J_number_child_plus', function ($thisEle) { var childNumberDom = $(J_child_number_str); var childNum = parseInt(childNumberDom.value()) || 0; if(childNum >= 8){ if(childNum >= 9){ return; } $(J_number_child_plus_str).addClass('number_disable'); } if(childNum >=0 ){ $(J_number_child_minus_str).removeClass('number_disable'); } childNumberDom.value( childNum + 1); var childCount = childNum + 1; var childAgeSelectedList = getChildAgeSelectedVal(childCount); $(divChildStr).removeClass('hidden').html($.tmpl.render($J_cildAgeSelectorTplB.html(), {childNum: childCount, childAgeSelectedList: childAgeSelectedList})); var checkIn = $('#inteCheckIn').value().toDate() || new Date().addDays(1); var today = '儿童年龄（' + checkIn.getFullYear() + '年' + (checkIn.getMonth() + 1) + '月' + checkIn.getDate() + '日当天）'; $(dtChildYear_str).text(today); }); $J_cildNumSelectorBox.on('click', '.J_number_child_minus', function ($thisEle) { var childNumberDom = $(J_child_number_str); var childNum = parseInt(childNumberDom.value()) || 0; if(childNum <= 1){ if(childNum <= 0){ return; } $(J_number_child_minus_str).addClass('number_disable'); } if(childNum <=9 ){ $(J_number_child_plus_str).removeClass('number_disable'); } childNumberDom.value( childNum - 1); var childCount = childNum - 1; var childAgeSelectedList = getChildAgeSelectedVal(childCount); $(divChildStr).removeClass('hidden').html($.tmpl.render($J_cildAgeSelectorTplB.html(), {childNum: childCount, childAgeSelectedList: childAgeSelectedList})); var checkIn = $('#inteCheckIn').value().toDate(); var today = '儿童年龄（' + checkIn.getFullYear() + '年' + (checkIn.getMonth() + 1) + '月' + checkIn.getDate() + '日当天）'; $(dtChildYear_str).text(today); }); $J_cildNumSelectorBox.on('click', '#confirmChildB', function ($thisEle) { var selAudlt = $(J_adult_number_str); var selChild = $(J_child_number_str); if (parseInt(selChild.value()) == 0 && (selAudlt.value() == 1 || selAudlt.value() == 2)) { $('#inteRooms').value(selAudlt.value() + '成人'); $('#childNum').value(selAudlt.value()); } else { var strChild = ''; var intChild = parseInt(selChild.value()); var valid = true; if (intChild > 0) { for (var i = 1; i <= intChild; i++) { var c = parseInt($('#child' + i).find('select').value()); if(c == -1){ valid = false; break; } strChild += '-' + c; } }; if(!valid){ $(J_default_child_tips_str).removeClass('hidden'); return; }else{ $(J_default_child_tips_str).addClass('hidden'); } $('#childNum').value(selAudlt.value() + strChild); BuildOption(selAudlt.value(), selChild.value()); } $J_cildNumSelectorBox.addClass('hidden'); $J_cildNumBox.removeClass('n_gst38578_active'); }); $J_cildNumSelectorBox.on('click', '#cancelChildB', function ($thisEle) { $J_cildNumBox.removeClass('n_gst38578_active'); }); } } initPersonSearch(); // 备份 InteMod.langConf = { taiwan: '台湾', search_history: '搜索历史', hot_airport: '热门机场', city_sourceResult: '支持中文/英文/拼音输入', keyword_sourceResult: '支持中文/英文输入', filterResult: '${val},若需缩小范围，请输入更多条件。', noFilterResult: '找不到：${val}', city: '城市', province: '省份', airport: '机场', city_placeholder: '城市/机场/地标/酒店', hotel: '酒店', name: '酒店', landmark: '地标', railwaystation: '车站', weizhi: '位置', keyword_placeholder: '(选填)酒店/地标', IntTitle: '海外城市', Title: '国内城市', Location: '行政区', District: '景区', intlDistrict: '景区', Station: '机场/车站', metrostation: '地铁站', metro: '地铁线', brand: '品牌', group: '集团', zone: '商圈', busArea: '商圈', flagship: '集团酒店', notice: { city: '请选择酒店所在城市', checkIn: '请选择入住日期', checkOut: '请选择离店日期', dateErr: '日期格式为yyyy-mm-dd', too_early_in: '入住日期不能早于今天', too_early_out: '您选择的离店日期早于/等于入住日期，请重新选择', too_long: '您入住酒店时间超过28天，请分订单提交预订' } }; //placeholder的分流 function NoticePlaceholder($thisEle){ var _tipsVal = (InteMod && InteMod.langConf && InteMod.langConf.keyword_placeholder) || ''; this.html5PlaceholderUse = function(){ $thisEle.get(0).setAttribute("placeholder", _tipsVal); if($thisEle.hasClass('inputSel')){$thisEle.removeClass('inputSel')}; }; }; if($.browser.isIPad && $('#inteHotelName').length && InteMod && InteMod.langConf && InteMod.langConf.keyword_placeholder){ var noticePlaceholderInstance = new NoticePlaceholder($('#inteHotelName')); }; //$.extend(InteMod.langConf, win.inteConf || {}); //关键字用户行为 win.userBehaviorKeyWordInfo = { "searchType": "S", "cityId": null, "keyword": null }; //用户行为跟踪 ; (function () { $('#HI_Btn').bind("click", function () { win.userBehaviorKeyWordInfo.cityId = $("#inteCityId").value(); win.userBehaviorKeyWordInfo.keyword = $("#inteHotelName").value(); //发送用户行为记录请求 win['__bfi'].push(['_tracklog', "SEARCH_AUTOCOMPLET_US", $.stringifyJSON(win.userBehaviorKeyWordInfo)]); //请求后还原 win.userBehaviorKeyWordInfo = { "searchType": "S", "cityId": null, "keyword": null }; }); })(); //全球时区 var timeZone = (function () { var _uctDate = '1970-01-22 19:28:28'.toDateTime(); var initFinalDate; var _self = this; var checkInInputNew; var checkOutInputNew; /*function _buildParam(formEle, inputName, inputId, inputValue) { var el = formEle[inputName]; if (!el) { el = document.createElement('input'); el.type = 'hidden'; el.name = inputName; el.id = inputId; formEle.appendChild(el); }; };*/ /*function _setHiddenVal(receivedOffsetDate, receivedUtcDate){ $('#receivedOffsetDate').value(receivedOffsetDate); $('#receivedUtcDate').value(receivedUtcDate); };*/ function _checkTodateChange(finalDate){ //验证当天的日期改变 $.v0 = finalDate.toDate(); }; function _setTodayDate(dateObject, todayDate){ dateObject.method('setDate', todayDate); }; function _calendarBackChange(finalDateStr, $checkInInput, $checkOutInput){ //强行修改minDate if(!finalDateStr){return;}; //if(finalDate < new Date()){ $checkInInput.data('minDate', finalDateStr); _setTodayDate(checkInInputNew, finalDateStr); $checkOutInput.data('minDate', $checkInInput.value().toDate().addDays(1).toFormatString('yyyy-MM-dd')); _setTodayDate(checkInInputNew, finalDateStr); _checkTodateChange(finalDateStr); //}; $.cookie.del('userinfo','checkInMinDate'); }; function _construct(receivedOffsetDate, receivedUtcDate, $checkInInput, $checkOutInput){ //receivedUtcDate: 固定的格林尼治时间 if(!receivedOffsetDate){return;}; if(_uctDate.getTime() < receivedUtcDate.getTime()){ _uctDate = receivedUtcDate; }; $.browser.isChrome && console.log('uctDate:' + _uctDate); var finalDate = _uctDate.addSeconds(receivedOffsetDate); if(timeZone.isInitState){ initFinalDate = finalDate.toFormatString('yyyy-MM-dd'); }; $.browser.isChrome && console.log('finalDate:' + finalDate); $checkInInput.data('minDate', finalDate.toFormatString('yyyy-MM-dd')); _setTodayDate(checkInInputNew, finalDate.toFormatString('yyyy-MM-dd')); _setTodayDate(checkOutInputNew, finalDate.toFormatString('yyyy-MM-dd')); //$checkOutInput.data('minDate', //$checkInInput.value().toDate().addDays(1).toFormatString('yyyy-MM-dd')); var txtCheckOutDate = finalDate.addDays(1).toFormatString('yyyy-MM-dd'); _checkTodateChange(finalDate); //与c_idnex.js, c_result.js, c_detail_rateplan.js, map.js, country-landing-page.js, city-landing-page.js页面的联动端口 //验证当天的日期 //强行修改用户当前所选的日期(minDate的联动) if($checkInInput.data('minDate').toDate() > $checkInInput.value().toDate()){ $checkInInput.value(finalDate.toFormatString('yyyy-MM-dd')); _setTodayDate(checkInInputNew, finalDate.toFormatString('yyyy-MM-dd')); if($checkOutInput.data('minDate') && $checkOutInput.data('minDate').toDate() >= $checkOutInput.value().toDate()){ $checkOutInput.value(txtCheckOutDate); _setTodayDate(checkOutInputNew, finalDate.toFormatString('yyyy-MM-dd')); }; }; //checkOut自动随着checkIn改变 $checkInInput.trigger('change'); //关联性,由于checkIn与checkOut是通过change事件相关联的，checkout自动会判断最小并随着checkIn切换 //为隐藏域赋值 //_setHiddenVal(receivedOffsetDate, receivedUtcDate); }; function _getInstance(checkInInputInstance, checkOutInputInstance){ //详情页的订单中也有有两个input，会_getInstance()在初始化时，会被执行两次，checkInInputNew会被覆盖 if(checkInInputNew && checkOutInputNew) return; checkInInputNew = checkInInputInstance; checkOutInputNew = checkOutInputInstance; }; /*function _initCreateHidden(){ _buildParam($('#aspnetForm')[0], '', 'receivedOffsetDate', 'receivedOffsetDate'); _buildParam($('#aspnetForm')[0], '', 'receivedUtcDate', 'receivedUtcDate'); };*/ function _bindEvent(){ window.onbeforeunload = function(){ if(initFinalDate){ $.cookie.set('userinfo','checkInMinDate', initFinalDate); } }; }; function _initSetData(){ setTimeout(function(){ //列表页的初始化 if($('#txtCheckIn').length && $('#txtCheckOut').length){ _construct(parseInt($('#receivedOffsetDate').value()), $('#receivedUtcDate').value().toDateTime(), $('#txtCheckIn'), $('#txtCheckOut')); } if($('#change_txtCheckIn').length && $('#change_txtCheckOut').length){ //详情页2个日历选择器 _construct(parseInt($('#receivedOffsetDate').value()), $('#receivedUtcDate').value().toDateTime(), $('#change_txtCheckIn'), $('#change_txtCheckOut')); }; //首页的初始化 if(!$('#receivedOffsetDate').length){ //用$('#receivedOffsetDate') dom判断是否是海外首页 $('#inteCheckIn').trigger('change'); //解决大首页日历bug _calendarBackChange($.cookie.get('userinfo','checkInMinDate'), $('#txtCheckIn'), $('#txtCheckOut')); }; },500); }; //_initCreateHidden(); _initSetData(); _bindEvent(); return { construct: _construct, getInstance: _getInstance, initSetData: _initSetData, isInitState: true }; })(); // PRO: 生产, UAT: UAT, TEST: 测试 // GB: 简体版, BIG5: 繁体版, HK: 香港版 var envObj = { 'PRO': { 'GB': '//hotels.ctrip.com', 'HK': '//hotels.ctrip.com.hk', 'BIG5': '//hotels.big5.ctrip.com' }, 'UAT': { 'GB': '//hotels.uat.sh.ctriptravel.com', 'HK': '//hotels.big5.uat.sh.ctriptravel.com', 'BIG5': '//hotels.big5.uat.sh.ctriptravel.com' }, 'UAT_NT': { 'GB': '//hotels.ctrip.uat.qa.nt.ctripcorp.com', 'HK': '//hotels.ctrip.big5.uat.qa.nt.ctripcorp.com', 'BIG5': '//hotels.ctrip.big5.uat.qa.nt.ctripcorp.com' }, 'TEST': { 'GB': '//hotels.testp.sh.ctriptravel.com', 'HK': '//hotels.big5.testp.sh.ctriptravel.com', 'BIG5': '//hotels.big5.testp.sh.ctriptravel.com' }, 'FAT': { 'GB': '//hotels.ctrip.fat2.qa.nt.ctripcorp.com', 'HK': '//hotels.ctrip.fat2.qa.nt.ctripcorp.com', 'BIG5': '//hotels.ctrip.fat2.qa.nt.ctripcorp.com' } }; var ENV = '//hotels.ctrip.com'; var solution = document.getElementById('solution'); var arrEnv = solution && solution.value && solution.value.toUpperCase().split('|'); if (arrEnv && arrEnv.length) { ENV = envObj[arrEnv[0]][arrEnv[1]]; window.intlEvnObj = ENV; } var MAX_STAY = 28 * 24 * 3600 * 1000; var $isPad = /pad/.test(navigator.userAgent.toLowerCase()); var CURRENTCITY = { id: '', py: '', url: '', isIntl: true }; //var _CURRENTCITY = { py: ''}; var CITYENTER = true; var citySource = ENV + '/international/Tool/citySource_J.aspx?charset=gb2312'; var cityFilter = ENV + '/international/Tool/cityFilter.ashx?charset=gb2312&flagship=1&keyword=${key}'; var keywordSource = ENV + '/international/Tool/keywordSourceBeta.ashx?charset=gb2312&cityId=${id}'; var keywordFilter = ENV + '/international/Tool/keywordFilterBeta.aspx?charset=gb2312&flagship=1&cityId=${id}&keyword=${key}'; var keywordSourceDomestic = ENV + '/international/Tool/keywordSourceDomestic.ashx?cityid=${id}'; var keywordFilterDomestic = ENV + '/international/Tool/keywordFilterDomestic.ashx?cityId=${id}&keyword=${key}' var txtKeyword = $('#inteHotelName'); var fm = document.getElementById('inteHotelForm'); var filterStyle = '\ .city_suggestion_pop{width:496px;border:1px solid #ccc;background-color:#fff;}\ .city_suggestion_pop .title{height:26px;margin:0 10px 4px;padding-left:2px;border-bottom:1px dotted #ccc;line-height:26px;color:#999;}\ .city_suggestion_pop .close{float:right;width:26px;height:26px;font:bold 14px/26px Simsun;color:#666;text-align:center;cursor:default;}\ .notfound_pop{padding:4px 0;}\ .notfound_pop .title{overflow:hidden;color:#c01111;border-bottom:0 none;word-break:break-all;}\ .notfound_pop .close{margin-top:2px;}\ .city_suggestion_pop .text_input{float:left;max-width:210px;_width:210px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}\ .city_suggestion_pop .close:hover{text-decoration:none;color:#FFA800;}\ .city_suggestion_pop .sug_item{overflow:hidden;border-bottom:1px solid #ccc;margin-bottom:-1px;}\ .city_suggestion_pop .sug_item a{display:block;overflow:hidden;padding:1px 10px;color:#000;font-family:Tahoma;line-height:1.5;cursor:default;*zoom:1;}\ .city_suggestion_pop .sug_item a:after{clear:both;content:".";display:block;height:0;overflow:hidden;}\ .city_suggestion_pop .sug_item .num{float:left;width:80px;overflow:hidden;padding:5px 0;color:#999;text-align:right;}\ .city_suggestion_pop .sug_item .city{display:block;float:left;width:288px;margin:5px 0;max-height:36px;_height:28px;padding-right:4px;overflow:hidden;white-space:normal;}\ .city_suggestion_pop .sug_item .en{color:#999;}\ .keywords_pop .sug_item .en{color:#333;}\ .city_suggestion_pop .sug_item b{font-weight:bold;color:#06c;}\ .city_suggestion_pop .sug_item a:hover,.city_suggestion_pop .sug_item .hover{background-color:#2577e3;color:#fff;text-decoration:none;}\ .city_suggestion_pop .sug_item a:hover span,.city_suggestion_pop .sug_item .hover span,.city_suggestion_pop .sug_item a:hover b,.city_suggestion_pop .sug_item .hover b{color:#fff;}\ .city_suggestion_pop .sug_item_hotel .city{width:385px;}\ .city_suggestion_pop .sug_category{float:right;width:62px;height:28px;line-height:28px;text-align:right;}\ .poweredbygoogle{width:143px;height:18px;overflow:hidden;margin:10px 8px 10px auto;background:url(//pic.c-ctrip.com/htlpic/common/icon_hotel.png?20170515) 0 -246px no-repeat;}\ .t_relation{padding:0 12px;height:30px;line-height:30px;font-size:12px;overflow:hidden;background-color:#f2f2f2;color:#666;border-top:1px solid #ccc;}\ .t_relation .keyword{display:inline-block;_display:inline;vertical-align:-6px;*vertical-align:-1px;max-width:200px;line-height:20px;overflow:hidden;white-space:nowrap;_white-space:normal;text-overflow:ellipsis;_text-overflow:clip;color:#2577e3;font-weight:bold;}\ '; InteMod.tmpl = { // 用于模版的函数 partitionDestnation: function (item) { var arr = item.data.split('|'); var type = arr[2]; var num = arr[8]; if(num > 0){ item.num = num + "家酒店"; } else if(num&&num.indexOf("家酒店")>0){ item.num = num; } switch(type){ case 'city': item.typeName = InteMod.langConf.city;break; case 'IntlProvince': item.typeName = InteMod.langConf.province;break; case 'intlDistrict': item.typeName = InteMod.langConf.intlDistrict;break; case 'landmark': item.typeName = InteMod.langConf.landmark;break; case 'zone': item.typeName = InteMod.langConf.zone;break; case 'airport': item.typeName = InteMod.langConf.airport;break; case 'station': item.typeName = InteMod.langConf.metrostation;break; case 'railwaystation': item.typeName = InteMod.langConf.railwaystation;break; case 'hotel':{ item.css = "sug_item_hotel"; item.typeName = InteMod.langConf.hotel; break; } case 'google': { item.css = "sug_item_auto"; item.isGoogleResult= true; break; } case 'flagship': item.typeName = InteMod.langConf.flagship; break; } //解决@|等符号冲突 item.left = decodeURIComponent(arr[0]); item.right = decodeURIComponent(arr[1]); //保持原样，免得引起问题 item.data = decodeURIComponent(item.data); return item; }, groupKeyWordSource: function (source){ if(source && source.length){ var group={result:[],recom:[]}; source.each(function(item){ var arr = item.data.split('|'); var type = arr[5]; switch(type){ case 'city': case 'city_recom': item.typeName = InteMod.langConf.city;break; case 'landmark': case 'landmark_recom': item.typeName = InteMod.langConf.landmark;break; case 'zone': case 'zone_recom': item.typeName = InteMod.langConf.zone;break; case 'airport': case 'airport_recom': item.typeName = InteMod.langConf.airport;break; case 'hotel': case 'hotel_recom':{ item.css = "sug_item_hotel"; item.typeName = InteMod.langConf.hotel; break; } case 'station': case 'station_recom':{ item.typeName = InteMod.langConf.metrostation; break; } case 'railwaystation': case 'railwaystation_recom':{ item.typeName = InteMod.langConf.railwaystation; break; } case 'metro': case 'metro_recom':{ item.typeName = InteMod.langConf.metro; break; } case 'brand': case 'brand_recom':{ item.typeName = InteMod.langConf.brand; break; } case 'group': case 'group_recom':{ item.typeName = InteMod.langConf.group; break; } case 'flagship': item.typeName = InteMod.langConf.flagship; break; } //解决@|等符号冲突 item.left = decodeURIComponent(arr[0]); item.right = decodeURIComponent(arr[1]); //保持原样，免得引起问题 item.data = decodeURIComponent(item.data); if(type.indexOf('_recom') == -1){ group.result.push(item); } else{ group.recom.push(item); //推荐数据 }; }); return group; } }, getKeywordsVal: function(){ return $('#inteHotelName').value(); }, // 输入内容高亮 HighLightAddressResult: function (result, value) { var reg = new RegExp(filterSpicalCharForRegx(value), 'i'); return result.replace(reg, '$&'); }, byteLength: function (str) { var len = str.length; var n = len; for (var i = 0; i < len; i++) { if (str.charCodeAt(i) > 255) n++; } return n; }, setHistory: function (arry) { var his = document.createElement('div'); his.className = 's_item_hotel'; his.id = 'HD_SearchHistory'; var s = '搜索历史'; var list = document.createElement('div'); list.className = 'history_list'; list.id = 'inteHistoryList'; his.innerHTML = s; var hitLength = arry.length >= 5 ? 5 : arry.length; for (var i = 0; i < hitLength; i++) { var hc = arry[i].data.split('|'); if (hc[5] && hc[6]) { var startTime = new Date(hc[5]); if ((startTime - new Date()) < 0) continue; var a = document.createElement('a'); a.className = 'history_item item_past'; a.href = 'javascript:void(0)'; $(a).data('data', hc); var city = document.createElement('span'); city.className = 'city'; city.innerText = arry[i].display; var date = document.createElement('span'); date.className = 'date'; date.innerText = hc[5] + ' 至 ' + hc[6]; a.appendChild(city); a.appendChild(date); list.appendChild(a); $(a).bind('click', function (e) { var h = $(this).data('data'); $('#inteCheckIn').value(h[5]); $('#inteCheckOut').value(h[6]); InteMod.tmpl.addressFilterChange(e, { items: h }, document.getElementById('inteCityName')); }); } } if ($(list).find('a').length > 0) { //ie7下使用.attr('class')会导致第一个class无法消除，鬼知道cQuery在搞点啥 if ($.browser.isIE7) { $('#inteCityName').get(0).className = 'w06'; $('#inteCityName').parentNode().get(0).className = 's_item w05'; } else { $("#inteCityName").attr('class', 'w06'); $('#inteCityName').parentNode().attr('class', 's_item w05'); } his.appendChild(list); $(his).insertAfter($('#inteCityName').parentNode()); } //cQuery的toggleClass貌似不起作用了…… var toggle = function (tar, cl) { if (tar.hasClass(cl)) { tar.removeClass(cl); } else { tar.addClass(cl); } }; var closeHistory = function () { if ($('#btnInteSearchHistory').hasClass('s_history_btn_hover')) $('#btnInteSearchHistory').trigger('click'); } $('#btnInteSearchHistory').bind('click', function (e) { toggle($(this), 's_history_btn_hover'); if ($('#inteHistoryList').css('display') == 'none') { $('#inteHistoryList').css('display', 'block'); } else { $('#inteHistoryList').css('display', 'none'); } var e = window.event; e.preventDefault ? e.stopPropagation() : e.cancelBubble = true; e.preventDefault ? e.preventDefault() : e.returnValue = false; }); if ($('#btnInteSearchHistory').length) { $('body').bind('click', closeHistory); if ($.browser.isFirefox) { loadEvent(); } } }, addressFilterChange: function (mod, evt, that) { CITYENTER = false; CURRENTCITY = {};//清空初始化 $('#inteHotelName').removeClass("disabled"); $('#inteHotelName').removeAttr("disabled"); if (InteMod.n_keyword) InteMod.n_keyword.method('resetValue'); var cityId = $('#inteCityId'); var items = evt.items; timeZone.isInitState = false; $.browser.isChrome && console.log('items[11]: ' + items[11], 'items[12]: ' + items[12]); if($('#inteCheckIn').length && $('#inteCheckOut').length && items[11] && items[12]){ timeZone.construct(parseInt(items[11]), items[12].toDateTime(), $('#inteCheckIn'), $('#inteCheckOut')); }; if (items && items[2]) { items[0] = decodeURIComponent(items[0]); items[1] = decodeURIComponent(items[1]); items[4] = decodeURIComponent(items[4]); items[7] = decodeURIComponent(items[7]); that.value = items[1]; var isIntl = items[8] === '1' ? false : true; CURRENTCITY.id = items[3]; //_CURRENTCITY.py = items[0]; CURRENTCITY.py = items[0]; CURRENTCITY.cityName = items[4]; CURRENTCITY.isIntl = items[9] == 0 ? true : false; CURRENTCITY.isAddressSelected = true; var keywordArg = { itemId: CURRENTCITY.id, isDomesitcFilter: false, cityDisplay: '', keywordDisplay: '', DestinationType: 1//1-city,2-province,3-country,4-district 5-airport }; var appPath = CURRENTCITY.isIntl ? '/international/' : '/hotel/' ; cityId.attr('_lastvalue', that.value); switch (items[2]) { case 'city': if (CURRENTCITY.isIntl) { CURRENTCITY.url = appPath + items[4] + items[3]; CURRENTCITY.itemId = items[4] + items[3]; keywordArg.itemId = CURRENTCITY.id; } else { CURRENTCITY.url = appPath + items[4] + items[3]; keywordArg.isDomesitcFilter = true; keywordArg.itemId = CURRENTCITY.id; } CURRENTCITY.py = items[4]; break; case 'intlDistrict': if(CURRENTCITY.isIntl){ CURRENTCITY.id = items[3]; CURRENTCITY.py = 'D'; CURRENTCITY.url = appPath + CURRENTCITY.py + CURRENTCITY.id; CURRENTCITY.itemId = CURRENTCITY.py + CURRENTCITY.id; keywordArg.DestinationType = 4; }else{ CURRENTCITY.id = items[5]; CURRENTCITY.py = items[6]; CURRENTCITY.url = appPath + items[0] + 'D' + items[3] + '_' + items[5]; keywordArg.isDomesitcFilter = true; keywordArg.itemId = CURRENTCITY.id; } break; case 'IntlProvince': CURRENTCITY.id = items[3]; CURRENTCITY.py = 'province'; CURRENTCITY.url = appPath + CURRENTCITY.py + CURRENTCITY.id; CURRENTCITY.itemId = CURRENTCITY.py + CURRENTCITY.id; keywordArg.DestinationType = 2; keywordArg.itemId = CURRENTCITY.id; break; case 'landmark': case 'railwaystation': CURRENTCITY.id = items[5]; CURRENTCITY.py = items[6]; CURRENTCITY.url = appPath + CURRENTCITY.py + CURRENTCITY.id + (CURRENTCITY.isIntl ? '/s' : '/sl') + items[3]; CURRENTCITY.itemId = CURRENTCITY.py + CURRENTCITY.id + (CURRENTCITY.isIntl ? '/s' : '/sl') + items[3]; keywordArg.cityDisplay = items[4]; //HTL04HW - 1745 使文字结构保持一致【英文名（中文名）】 if (items[0]) { keywordArg.keywordDisplay = items[0] + '(' + items[7] + ')'; } else { keywordArg.keywordDisplay = items[7]; } keywordArg.itemId = CURRENTCITY.id; break; case 'airport': CURRENTCITY.id = items[5]; CURRENTCITY.py = items[6]; CURRENTCITY.url = appPath + CURRENTCITY.py + CURRENTCITY.id + (CURRENTCITY.isIntl ? '/s' : '/sl') + items[3]; CURRENTCITY.itemId = CURRENTCITY.py + CURRENTCITY.id + (CURRENTCITY.isIntl ? '/s' : '/sl') + items[3]; keywordArg.cityDisplay = items[4]; //HTL04HW - 1745 使文字结构保持一致【英文名（中文名）】 if (items[0]) { keywordArg.keywordDisplay = items[0] + '(' + items[7] + ')'; } else { keywordArg.keywordDisplay = items[7]; } keywordArg.itemId = CURRENTCITY.id; break; case 'station': CURRENTCITY.id = items[5]; CURRENTCITY.py = items[6]; CURRENTCITY.url = appPath + CURRENTCITY.py + CURRENTCITY.id + (CURRENTCITY.isIntl ? '/m' : '/s') + items[3]; CURRENTCITY.itemId = CURRENTCITY.py + CURRENTCITY.id + (CURRENTCITY.isIntl ? '/m' : '/s') + items[3]; keywordArg.cityDisplay = items[4]; //HTL04HW - 1745 使文字结构保持一致【英文名（中文名）】 if (items[0]) { keywordArg.keywordDisplay = items[0] + '(' + items[7] + ')'; } else { keywordArg.keywordDisplay = items[7]; } keywordArg.itemId = CURRENTCITY.id; break; case 'zone': CURRENTCITY.id = items[5]; CURRENTCITY.py = items[6]; CURRENTCITY.url = appPath + CURRENTCITY.py + CURRENTCITY.id + '/zone' + items[3];; CURRENTCITY.itemId = CURRENTCITY.py + CURRENTCITY.id + '/zone' + items[3]; keywordArg.cityDisplay = items[4]; //HTL04HW - 1745 使文字结构保持一致【英文名（中文名）】 keywordArg.keywordDisplay = items[0] + '(' + items[7] + ')'; keywordArg.itemId = CURRENTCITY.id; break; case 'location': CURRENTCITY.id = items[5]; CURRENTCITY.py = items[6]; CURRENTCITY.url = appPath + CURRENTCITY.py + CURRENTCITY.id + '/location' + items[3]; keywordArg.isDomesitcFilter = true; keywordArg.cityDisplay = items[4]; keywordArg.keywordDisplay = items[7]; keywordArg.itemId = CURRENTCITY.id; break; case 'hotel': CURRENTCITY.url = appPath + items[6] + items[5] + '/' + (items[7] ? 'k2' + encodeURIComponent(items[7]) : ''); CURRENTCITY.id = items[5]; CURRENTCITY.py = items[6]; keywordArg.itemId = CURRENTCITY.id; keywordArg.cityDisplay = items[4]; keywordArg.keywordDisplay = items[7]; break; case 'google': CURRENTCITY.id = items[3]; CURRENTCITY.py = ''; CURRENTCITY.url = ''; CURRENTCITY.type = items[2]; window.DestinationType = keywordArg.DestinationType = 6; $('#inteHotelName').addClass("disabled"); $('#inteHotelName').attr("disabled","disabled"); break; case 'flagship': window.location.href = 'http://hotels.ctrip.com/flagship/hyatt/'; return; break; default: CURRENTCITY.id = ''; CURRENTCITY.py = ''; CURRENTCITY.url = ''; break; } setKeywordData(keywordArg); } else { CURRENTCITY.id = ''; CURRENTCITY.py = ''; CURRENTCITY.isIntl = true; } if (that.value != that.getAttribute('_lastvalue')) { that.setAttribute('_lastvalue', that.value); } setTimeout(function () { CITYENTER = true }, 100); $('#inteCityId').value(CURRENTCITY.id); $('#inteCityPy').value(CURRENTCITY.py); $('#inteCityName')[0].blur(); sentBFI(); //坑爹的新埋点 if (!$('#inteCityName').attr('tracked')) { blurTrace(($('#inteCityName').value() ? 'T' : 'F'), 'F', 'destination') } //国内结果直接跳转 if(!CURRENTCITY.isIntl){ $('#HI_Btn').length && document.getElementById('HI_Btn').click(); } }, keywordFilterChange: function (data, keyword) { // keyword_enName|keyword_cnName|id|url|hotel_count|keyword_type|cityId|city_enName // 目的地选择机场时，才有cityId和city_enName，否则cityId和city_enName为空 var items = data.items; if (!items) return; if (IsDomestic) { keyword.attr('url', InteMod.tmpl.domesticKeywordToUrl(items[3], items[2])); } else { keyword.attr('url', items[3]); } keyword.attr('_type', items[5]); keyword.attr('_typeId',items[2]); keyword.attr('keyworddata', items[2] + '|' + items[3].replace(/Markland|RailwayStation|Airport/g, 'sl').replace(/Zone/g, 'zone').replace(/MetroStation/gi, 's').replace(/Metro/gi, 'l').replace(/Location/gi, 'location')); if(items[5] == 'flagship'){ window.location.href = "http://hotels.ctrip.com/flagship/hyatt/"; return; } var cityId = items[6]; var cityPY = items[7]; var hotelId = items[2]; if (items[5] && items[5] == "hotel" && hotelId && $('#hotelId').length > 0) { $('#hotelId').value(hotelId); } if (cityId && cityPY) { if(window.DestinationType!=2 || (window.DestinationType==2 && (items[5] == "city"||items[5].indexOf('_recom') != -1))){ $('#inteCityId').value(cityId); CURRENTCITY.py = cityPY.replace('(', '').replace(')', ''); $('#inteCityPy').value(CURRENTCITY.py); } }; if(items[5] == "city"){ $('#inteCityName').value(items[0]); window.DestinationType = 1; } //HTL04HW-1745 需要显示【英文名（中文名）】 if (items[0] && items[1].indexOf('(') < 0) { if (items[1]) { keyword.value(items[1] + '(' + items[0] + ')'); } else { keyword.value(items[0]); } } if (IsDomestic) { keyword.value(items[0] ? items[0] : items[1]); } //坑爹的新需求，如果用户点击的是酒店，则直接跳转到详情页 /*if (items[5] == 'hotel') { window.location.href = '//hotels.ctrip.com/international/' + items[2] + '.html?CheckIn=' + $('#inteCheckIn').value() + '&CheckOut=' + $('#inteCheckOut').value() + '&childNum=' + $('#childNum').value() + '&NoShowSearchBox=T'; ; } else { setTimeout(function () { keyword[0].blur(); document.getElementById('HI_Btn'); }, 200); }*/ if (items[5] == 'hotel' || items[5] == 'hotel_recom') { keyword.attr('_hotelId', items[2]); }; setTimeout(function () { //扩大化搜索改变cityId对应的name值 if(items[5].indexOf('_recom') != -1){ $('#inteCityName').value(items[0]); //时区目前接口数据缺失，没有时区部分的数据,无法打时区部分的cookie点 //timeZone.setDataForCookie(items[11], items[12]); }; keyword[0].blur(); document.getElementById('HI_Btn').click(); }, 200); sentBFI(); if (!($('#inteCityName').attr('tracked'))) { blurTrace('T', 'T', 'keyword'); } }, //将国内的关键词转换成url domesticKeywordToUrl: function (key, id) { var ret = key.replace(/Markland|RailwayStation|Airport/g, 'sl').replace(/Zone/g, 'zone').replace(/MetroStation/gi, 's').replace(/Metro/gi, 'l').replace(/Location/gi, 'location'); //从suggestion里选择的关键词key里面不包含id，从filter数据里选择的关键词key里面已包含id，所以要这么写 if (!/\d/.test(ret)) { return ret + id; } else { return ret; } } }; //opt = { // itemId: 0, // isDomesitcFilter: false, // cityDisplay: '', // keywordDisplay: '', // isAirport: false //}; function setKeywordData(opt) { if (!InteMod.a_keyword) return; if(opt.DestinationType==6) return; $('#inteHotelName').attr('url', ''); $('#inteHotelName').attr('_type', opt.type); CURRENTCITY.isAddressSelected = true; //ie6 filter数据出不来bug setTimeout(function () { if (opt.keywordDisplay) { var kw = $('#inteHotelName'); $('#inteCityName').value(opt.cityDisplay); document.getElementById('HI_Btn').focus(); if (kw.length) { kw.value(opt.keywordDisplay); kw.attr('_lastvalue', kw.value()); } } if (!opt.isDomesitcFilter) { IsDomestic = false; if (opt.DestinationType == 2 || opt.DestinationType == 4|| opt.DestinationType == 5) { $('#inteHotelName')[0].removeAttribute('readonly'); InteMod.a_keyword.set('jsonpSource', keywordSource.replace('${id}', opt.itemId) + '&DestinationType=' + opt.DestinationType); InteMod.a_keyword.set('jsonpFilter', keywordFilter.replace('${id}', opt.itemId) + '&DestinationType=' + opt.DestinationType); window.DestinationType = opt.DestinationType; } else { InteMod.a_keyword.set('jsonpSource', keywordSource.replace('${id}', opt.itemId) + '&DestinationType=' + opt.DestinationType); InteMod.a_keyword.set('jsonpFilter', keywordFilter.replace('${id}', opt.itemId) + '&DestinationType=' + opt.DestinationType); window.DestinationType = 1; } } else { IsDomestic = true; InteMod.a_keyword.set('jsonpSource', keywordSourceDomestic.replace('${id}', opt.itemId.replace('D', ''))); //InteMod.a_keyword.set('jsonpFilter', keywordFilterDomestic.replace('${id}', opt.itemId)); InteMod.a_keyword.set('jsonpFilter', keywordFilterDomestic.replace('${id}', opt.itemId)); } }, 0); } // 正则表达式的特殊字符处理 function filterSpicalCharForRegx(value) { var spicalChar = ['\\', '^', '$', '.', '*', '+', '=', ':', '|', '/', '(', ')', '[', ']', '{', '}']; for (var i = 0; i < spicalChar.length; i++) { value = value.replace(spicalChar[i], '\\' + spicalChar[i]); } return value; } var RegMod = function (options) { this.init(options); this.initNotice(); this.initAddress(); this.initKeyword(); if (this.ops.startDate.length && this.ops.endDate.length) { this.initCalendar(this.ops.startDate, this.ops.endDate); } if (this.ops.checkInDate.length && this.ops.checkOutDate.length) { this.initCalendar(this.ops.checkInDate, this.ops.checkOutDate); } this.initValidate(); //首次加载以后如果cookie里有城市，则需要初始化关键词的suggestion this.initFirstKeywordContent(); //加载搜索历史 this.initHistory(); }; $.extend(RegMod.prototype, { init: function (options) { this.ops = { city: [], startDate: [], endDate: [], keyword: [], checkInDate: [], checkOutDate: [] }; this.ops = $.extend(this.ops, options); }, initValidate: function () { InteMod.formValidator = $(fm).regMod("validate", PluginsVersion.validate); }, initAddress: function () { var txtCity = this.ops.city; var cityId = $('#inteCityId'); var cityPY = $('#inteCityPy'); if (txtCity.length) { var suggestionStyle = '\ .city_select_lhsl { position:relative; width:378px; padding:6px 10px 10px; border:1px solid #999; background-color:#fff; } \ .city_select_lhsl .search_history_title{ margin-bottom:2px; font-weight:bold; } \ .city_select_lhsl .close { float:right; margin-right: -5px; width:20px; height:20px; color:#666; text-align:center; font:bold 16px/20px Simsun; } \ .city_select_lhsl .close:hover { text-decoration:none; color:#FFA800; } \ .city_select_lhsl .ico_key,\ .city_select_lhsl .ico_unkey { display:none; } \ .city_select_lhsl .title { color:#999; margin-bottom: 10px;} \ .city_select_lhsl .tab_box { width:100%; height:22px; margin-bottom:6px; border-bottom:2px solid #ccc; } \ .city_select_lhsl .tab_box li { position:relative; float:left; display:inline; margin-right:10px; line-height:22px; cursor:pointer; } \ .city_select_lhsl .tab_box li b { display:none; } \ .city_select_lhsl .tab_box li span { padding:0 3px; } \ .city_select_lhsl .tab_box li span:hover,.city_select_lhsl .tab_box .li_hover{ color: #06c;} \ .city_select_lhsl .tab_box .selected { border-bottom:2px solid #06c; margin-bottom:-2px; font-weight:bold; color:#06c; } \ .city_select_lhsl .tab_box .selected b { display: none; position:absolute; top:23px; left:50%; display:block; width:0; height:0; margin-left:-5px; overflow:hidden; font-size:0; line-height:0; border-color:#06c transparent transparent transparent; border-style: solid dashed dashed dashed; border-width:5px; } \ .city_select_lhsl .search_history_box{ display:inline-block; margin-bottom: 10px;} \ .city_select_lhsl .search_history_box,.city_select_lhsl .city_item {display:block;overflow:hidden;} \ .city_select_lhsl .search_history_box a,.city_select_lhsl .city_item a { float:left; width:54px; height:24px; padding-left:5px; border:1px solid #fff; overflow:hidden; text-overflow:ellipsis; line-height:24px; color: #333; white-space: nowrap;} \ .city_select_lhsl .search_history_box a:hover,.city_select_lhsl .city_item a:hover{ text-decoration: none; color: #fff; background: #2577e3;} \ .city_select_lhsl .hot_airport_title{ font-weight: bold; margin-bottom: 8px;} \ .city_select_lhsl .airport_item{ overflow: hidden;} \ .city_select_lhsl .airport_item a{ float:left; width:100px; height:24px; margin-right: 20px; border:1px solid #fff; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; line-height:24px; color: #333; padding: 0;} \ .city_select_lhsl .airport_item a:hover{ text-decoration: none; color: #fff; background: #2577e3;} \ .city_select_pad { padding-top:5px; } \ .city_select_pad .title { margin:0 0 0 30px; } \ .city_select_pad .ico_key,\ .city_select_pad .ico_unkey { position:absolute; top:1px; left:1px; display:block; width:39px; height:25px; background:url(//pic.c-ctrip.com/ctripOnPad/un_key.png) no-repeat; -webkit-transform:scale(.7); } \ .city_select_pad .ico_unkey { background-position:0 -28px; } \ .city_select_pad .close,\ .city_select_pad .close:hover { font-family:helvetica,Simsun; color:#666; } \ .city_group_header{background-color:#eeeeef; padding:0 10px; margin:0 -10px; border-top:1px solid #e1e1e1;border-bottom:1px solid #e1e1e1; line-height:21px; font-weight:bolder; cursor:pointer;} \ .ico_arrow{width:0; height:0; border-width:0 5px 5px; border-style:dashed dashed solid; border-color:transparent transparent #9a9a9a; position:absolute; right:10px; vertical-align:middle; margin-top:8px; overflow:hidden;} \ .city_select_lhsl .tab_box .selected b{display:none;} \ .city_group{background-color:#fbfbfb; margin:0 -10px; padding:0 10px; overflow:hidden; *zoom:1;} \ .city_group .city_item a{border-color:#fbfbfb;} \ .tab_box{margin-top:10px;} \ .city_group{border-top:2px solid #d1d9de;} \ .city_group .ico_arrow{border-width:5px 5px 0; border-style:solid dashed dashed; border-color:#9a9a9a transparent transparent;} \ .sta_unfold .tab_box,.sta_unfold .city_item{display:none;} \ .sta_unfold .ico_arrow{border-style:dashed dashed solid; border-color:transparent transparent #9a9a9a; border-width:0 5px 5px; } \ .sta_unfold{border-top-width:1px;} \ .city_select_lhsl .hot_airport_title{margin-top:10px;} \ .city_select_lhsl .city_item a{white-space: nowrap;} \ .city_suggestion_pop .item_list_areaadmin .sug_category{background-position: right -404px;}\ .city_suggestion_pop .item_list_areaadmin .hover .sug_category{background-position: right -441px;}\ .city_suggestion_pop .item_list_areaadmin a:hover .sug_category{background-position: right -441px;}\ ' ; var suggestionStyleIpad = '\ .city_select_lhsl { position:relative; width:520px; padding:10px; border:1px solid #999; background-color:#fff; }\ .city_select_lhsl .search_history_title{ margin-bottom:2px; font-weight:bold; font-size:16px;}\ .city_select_lhsl .close { float:right; width:30px; height:30px; color:#666; text-align:center; font:bold 22px/30px "Heiti SC","Heiti SC light",STHeiti,STXihei,sans-serif;}\ .city_select_lhsl .title {display:none;}\ .city_select_lhsl .tab_box { width:100%; height:30px; margin-bottom:6px; border-bottom:2px solid #ccc; } \ .city_select_lhsl .tab_box li { position:relative; float:left; display:inline; margin-right:10px; line-height:30px; cursor:pointer; }\ .city_select_lhsl .tab_box li b { display:none; }\ .city_select_lhsl .tab_box li span { padding:0 8px; }\ .city_select_lhsl .tab_box .selected { border-bottom:2px solid #06c; margin-bottom:-2px; font-weight:bold; color:#06c; }\ .city_select_lhsl .tab_box .selected b { display: none; position:absolute; top:23px; left:50%; display:block; width:0; height:0; margin-left:-5px; overflow:hidden; font-size:0; line-height:0; border-color:#06c transparent transparent transparent; border-style: solid dashed dashed dashed; border-width:5px; }\ .city_select_lhsl .city_item,.city_select_lhsl .search_history_box {display:block;overflow:hidden;}\ .city_select_lhsl .city_item a,.city_select_lhsl .search_history_box a { float:left; width:75px; height:30px; padding-left:5px; overflow:hidden; text-overflow:ellipsis; line-height:30px; color: #333; text-decoration:none; margin: 0 6px 10px 0;}\ .city_select_lhsl .hot_airport_title{ font-weight: bold; margin-bottom: 8px;}\ .city_select_lhsl .airport_item{ overflow: hidden;}\ .city_select_lhsl .airport_item a{ float:left; width:150px; height:30px; margin:0 20px 10px 0; border:1px solid #fff; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; line-height:30px; color: #333; text-decoration:none; padding: 0;}\ .city_group_header{background-color:#eeeeef; padding:0 10px; margin:0 -10px; border-top:1px solid #e1e1e1;border-bottom:1px solid #e1e1e1; line-height:30px; font-weight:bolder; cursor:pointer;}\ .ico_arrow{width:0; height:0; border-width:0 5px 5px; border-style:dashed dashed solid; border-color:transparent transparent #9a9a9a; position:absolute; right:20px; vertical-align:middle; margin-top:14px; overflow:hidden;}\ .city_select_lhsl .tab_box .selected b{display:none;}\ .city_group{background-color:#fbfbfb; margin:0 -10px; padding:0 10px; overflow:hidden; *zoom:1;}\ .city_group .city_item a{border-color:#fbfbfb;}\ .tab_box{margin-top:10px;}\ .city_group{border-top:2px solid #d1d9de;}\ .city_group .ico_arrow{border-width:5px 5px 0; border-style:solid dashed dashed; border-color:#9a9a9a transparent transparent;}\ .sta_unfold .tab_box,.sta_unfold .city_item{display:none;}\ .sta_unfold .ico_arrow{border-style:dashed dashed solid; border-color:transparent transparent #9a9a9a; border-width:0 5px 5px; }\ .sta_unfold{border-top-width:1px;}\ .city_select_lhsl .hot_airport_title{margin-top:10px;}\ .city_select_lhsl .city_item a{white-space: nowrap;}\ .key_word_key{height:48px; display:block;}\ .ico_key, .ico_unkey{width:92px;height:43px;padding-left:65px;background:url(//pic.c-ctrip.com/ctripOnPad/un_key20131012.png) 10px 11px no-repeat;cursor:pointer;line-height:40px;font-size:18px;border-width:1px;border-style:solid;border-radius:3px;}\ .ico_key{border-color:#f0f0f0 #cfcfcf #707070;box-shadow:0 1px 0 #cfcfcf,1px 0 0 0 #f0f0f0 inset,-1px 0 0 0 #f0f0f0 inset,0 -1px 0 0 #f0f0f0 inset;}\ .ico_unkey{border-color:#898989 #e2e2e2 #e2e2e2;background-color:#f5f5f5;box-shadow:0 -1px 0 #e2e2e2,0 1px 0 #d1d1d1 inset;}\ .city_select_lhsl .history_item, .city_select_lhsl .city_item { display:inline-block; margin-bottom: 10px; }\ .city_select_lhsl .history_item, .city_select_lhsl .city_item { display:block; overflow:hidden; }\ .city_select_lhsl .history_item a, .city_select_lhsl .city_item a { float:left; width:54px; height:24px; padding-left:5px; border:1px solid #fff; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; line-height:24px; color: #333; }\ .city_select_lhsl .history_item a:hover, .city_select_lhsl .city_item a:hover { text-decoration: none; color: #fff; background: #2577e3;}\ '; InteMod.a_city = txtCity.regMod("address", PluginsVersion.address, { name: "inteCityName", jsonpSource: citySource, jsonpFilter: cityFilter, isFocusNext: false, isAutoCorrect: false, delay: 200, relate: { 2: cityId, 3: cityPY }, offset: 5, template: { suggestion: '\
    \ ×\
{{tmpl InteMod.langConf.city_sourceResult}}

\ {{if (data.history.length)}}\
{{tmpl InteMod.langConf.search_history}}

\
    \ {{each data.history}} 8)}} title="${display}"{{/if}}>${display}{{/each}}\
\ {{/if}}\ \ {{if (searchDomestic && searchDomestic == "T") }}\
\
{{tmpl InteMod.langConf.IntTitle}}

\ {{/if}}\
\ {{enum(key) data.cities}}
${key}{{/enum}}\
\ {{enum(key,arr) data.cities}}\
\ {{each arr}} 8)}} title="${display}"{{/if}}>${display}{{/each}}\
\ {{/enum}}\ {{if (searchDomestic && searchDomestic == "T") }}\
\ {{/if}}\ \ \ {{if (searchDomestic && searchDomestic == "T") }}\
\
{{tmpl InteMod.langConf.Title}}

\
\ {{enum(key) data.domesticCitys}}
${key}{{/enum}}\
\ {{enum(key,arr) data.domesticCitys}}\
\ {{each arr}} 8)}} title="${display}"{{/if}}>${display}{{/each}}\
\ {{/enum}}\
\ {{/if}}\ \ \ {{if (data.airport.length)}}\
{{tmpl InteMod.langConf.hot_airport}}

\
\ {{each data.airport}} 16)}} title="${display}"{{/if}}>${display}{{/each}}\
\ {{/if}}\
\ ', suggestionIpad: '\
\ ×\
显示键盘
\ {{if (d = $data.data)}}{{/if}}\ {{if (d.history.length)}}\
{{tmpl InteMod.langConf.search_history}}

\
\ {{each(index, item) d.history}}${item.display}{{/each}}\
\ {{/if}}\
\ {{enum(key) d.cities}}
${key}{{/enum}}\
\ {{enum(key,arr) d.cities}}\
\ {{each(index, item) arr}}${item.display}{{/each}}\
\ {{/enum}}\ {{if (d.airport.length)}}\
{{tmpl InteMod.langConf.hot_airport}}

\
\ {{each(index, item) d.airport}}${item.display}{{/each}}\
\ {{/if}}\
\ ', suggestionStyle: suggestionStyle, suggestionStyleIpad: suggestionStyle, suggestionInit: function (obj, test) { /** * 代码拷自address组件，实现tab切换， * 因为address组件只要用户配置了suggestionInit, 就不触发组件自己的suggestionInit，失去了tab切换功能 */ //must be opti var spans = obj.find('.tab_box li'); var uls = obj.find('div.city_item'); if (!spans.length) { return; } function switchTab() { var _this = this; spans.each(function (span, i) { if (span[0] == _this) { span.addClass('selected'); uls[i].style.display = ''; } else { span.removeClass('selected'); uls[i].style.display = 'none'; } }); } var w = 30; for (var i = 0, n = spans.length; i < n; i++) { w += spans[i].offsetWidth; } var t = obj.find('div').first(); if (t[0]) { if (w > 278) { t.css('width', '378px'); } } spans.bind('mousedown', switchTab); switchTab.apply(spans[0]); }, filter: '\ {{if (sentBFI())}}{{/if}}\ {{if hasResult}}\
\
\ ×\ {{tmpl InteMod.langConf.filterResult}}\

\ {{each (i, item) list}}\ {{if (InteMod.tmpl.partitionDestnation(item))}}\
\ \
${typeName}
\ \ {{tmpl InteMod.tmpl.HighLightAddressResult(right, val)}}\ {{if (left)}}({{tmpl InteMod.tmpl.HighLightAddressResult(left, val)}}){{/if}}\ \ {{if (item.num)}}${item.num}{{/if}}\ \
\ {{/if}}\ {{if $data.isGoogleResult = item.isGoogleResult}}{{/if}}\ {{/each}}\ {{if $data.isGoogleResult}}\
\ {{/if}}\
\ {{else}}\
\
\ ×{{tmpl InteMod.langConf.noFilterResult}}\

\
\ {{/if}}\ ', filterIpad: '\ {{if (sentBFI())}}{{/if}}\ {{if $data.hasResult}}\
\
\ ×\ ${$data.val},若需缩小范围，请输入更多条件。\

\ {{each (i, item) $data.list}}\ {{if InteMod.tmpl.partitionDestnation(item)}}\
\ \
${item.typeName}
\ \ {{tmpl InteMod.tmpl.HighLightAddressResult(item.right, $data.val)}}\ {{if (item.left)}}({{tmpl InteMod.tmpl.HighLightAddressResult(item.left, $data.val)}}){{/if}}\ \ {{if (item.num)}}${item.num}{{/if}}\ \
\ {{/if}}\ {{if $data.isGoogleResult = item.isGoogleResult}}{{/if}}\ {{/each}}\ {{if $data.isGoogleResult}}\
\ {{/if}}\
\ {{else}}\
\
\ ×找不到：${$data.val}\

\
\ {{/if}}\ ', filterPageSize: -1, filterStyle: filterStyle, filterStyleIpad: filterStyle } }); InteMod.a_city.method('bind', 'change', function (mod, evt) { InteMod.tmpl.addressFilterChange(mod, evt, document.getElementById('inteCityId')); }); //由于现在埋点需要分别记录用户输入的内容和最终地址选择器选择的内容，所以需要在内存中保留一份用户输入的原始信息 InteMod.a_city.method('bind', 'keyup', function () { $('#inteCityName').attr('rawInput', $('#inteCityName').value()); $('#inteCityName').attr('tracked', ''); $('#inteHotelName').attr('rawInput', ''); }); var isSelect = true; InteMod.a_city.method('bind', 'userinput', function (mod, evt) { var cityId = $('#inteCityId'); var cityPY = $('#inteCityPy'); //var cityVal = this.value; var cityVal = evt.autoCorrectValue; var _userBehaviorCityInfo = { "searchType": null, "cityId": cityId.value(), "keyword": cityVal }; // 用户选择的目的地，不再验证。用户选择有以下几种： // * evt.eventType === 'suggestionMousedown' 鼠标选择suggestion的数据 // * evt.eventType === 'filterMousedown' 鼠标选择filter的数据 // * evt.eventType === 'keydown' && evt.data 键盘回车选择filter的数据 // * evt.eventType === 'keydown' && isSelect 一时想不起来什么情况了 //酒店搜索自动补全用户行为记录 if (evt.eventType === 'suggestionMousedown') { _userBehaviorCityInfo['searchType'] = "CTY_X"; win['__bfi'].push(['_tracklog', "SEARCH_AUTOCOMPLET_US", $.stringifyJSON(_userBehaviorCityInfo)]); } if (evt.eventType === 'filterMousedown' || evt.eventType === 'keydown') { _userBehaviorCityInfo['searchType'] = "CTY_BS"; _userBehaviorCityInfo['Yindex'] = (evt.target && $(evt.target).attr("data-yindex")); _userBehaviorCityInfo['inputkeyword'] = evt.value; _userBehaviorCityInfo['fulldata'] = evt.data; win['__bfi'].push(['_tracklog', "SEARCH_AUTOCOMPLET_US", $.stringifyJSON(_userBehaviorCityInfo)]); } // if (evt.eventType === 'suggestionMousedown' || evt.eventType === 'filterMousedown' || (evt.eventType === 'keydown' && (isSelect || evt.data))) { isSelect = true; return; } // 用户选择，之后失去焦点时，也不再验证 if (evt.eventType === 'blur' && isSelect) return; var queryCityId = ''; if (!this.value || this.value == cityId.attr('_lastvalue')) { queryCityId = cityId.value(); } function clearCity() { txtCity.value(''); txtCity.attr('_lastvalue', ''); InteMod.n_city.method('resetValue'); cityId.value(''); cityId.attr('_lastvalue', ''); cityPY.value(''); cityPY.attr('_lastvalue', ''); } var url = InteMod.a_city.get('jsonpFilter').replace('${key}', encodeURIComponent(escape(txtCity.value()))); $.loader.js(url, { type: 'text/javascript', charset: 'utf-8', async: true, cache: false, onload: function () { if (cQuery.isEmptyObject(cQuery.jsonpResponse)) { clearCity(); return; } var resultData = cQuery.jsonpResponse; var data = resultData.data; var cityList = data.match(/[^@]+\|/g); if (cityList && cityList.length > 0) { var cityData = cityList[0].split('|'); evt.items = cityData; InteMod.tmpl.addressFilterChange(mod, evt, document.getElementById('inteCityName')); cQuery.jsonpResponse = {}; } else { clearCity(); } win.$_bf.tracklog("ihtlcity", makeTrackLogVals(resultData.key, txtCity.value())); //坑爹的新埋点 if (!($('#inteCityName').attr('tracked'))) { blurTrace((txtCity.value() ? 'T' : 'F'), 'F', 'destination') } }, onerror: clearCity }); }); txtCity.bind('focus', function () { CITYENTER = true; }).bind('keydown', function (e) { if (e.keyCode == 13) { isSelect = true; if (!CITYENTER || txtCity.attr('_lastvalue') != this.value) { CITYENTER = true; e.stop(); if ($('.notfound_pop').length > 0) { InteMod.n_city.method('resetValue'); } setTimeout(function () { txtCity[0].blur(); setTimeout(function () { HotelSearch.submit(false, true); }, 500); }, 100); } else { setTimeout(function () { if (HotelSearch.submit()) { var fm = document.forms[0]; SendAjaxImpressionLog(); $('#HI_Btn').addClass('s_btn_ing'); $('#HI_Btn').value('搜索中…'); fm.submit(); } else { $(this).get(0).focus(); } }, 500); } } else { isSelect = false; } }); // 给首页调用，用于focus到第一个输入框 win.inteHotelSF = function () { InteMod.a_city.method('focus', { isHidden: true, isSelected: true }); }; } }, initKeyword: function () { var keyword = this.ops.keyword; var suggestionStyle = '\ .choice_classification{ padding: 6px 10px 10px; width:468px; border:1px solid #ccc; background-color:#fff;}\ .choice_classification .close{ float:right; margin-right: -5px; width:20px; height:20px; color:#666; text-align:center; font:bold 16px/20px Simsun; }\ .choice_classification .close:hover{ text-decoration:none; color:#FFA800; }\ .choice_classification .title{ color: #999; }\ .choice_classification .choice_item_title{ margin-top: 15px; font-weight: bold;}\ .choice_classification .choice_item_list{ *zoom:1;}\ .choice_classification .choice_item_list:after{ clear:both; content:"."; display:block; height:0; overflow:hidden; }\ .choice_classification .choice_item_list a{ float:left; width:134px; height:24px; margin-right: 20px; border:1px solid #fff; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; line-height:24px; color: #333;}\ .choice_classification .choice_item_list a:hover{text-decoration: none; color: #fff; background: #2577e3;}\ .choice_classification .ico_key, .choice_classification .ico_unkey { display:none; }\ .choice_classification_pad { padding-top:5px; }\ .choice_classification_pad .title { margin:0 0 0 30px; }\ .choice_classification_pad .ico_key, .choice_classification_pad .ico_unkey { position:absolute; top:1px; left:1px; display:block; width:39px; height:25px; background:url(//pic.c-ctrip.com/ctripOnPad/un_key.png) no-repeat; -webkit-transform:scale(.7); }\ .choice_classification_pad .ico_unkey { background-position:0 -28px; }\ .choice_classification_pad .close, .choice_classification_pad .close:hover { font-family:helvetica,Simsun; color:#666; }\ '; if (keyword.length) { InteMod.a_keyword = keyword.regMod("address", PluginsVersion.address, { name: "inteKeyword", isFocusNext: false, isAutoCorrect: false, delay: 200, offset: 5, template: { suggestion: '\ {{if !cQuery.isEmptyObject(data)}}\ {{if (!IsDomestic)}}\
\ ×\
{{tmpl InteMod.langConf.keyword_sourceResult}}

\ {{enum(key,arr) data}}\
    ${key}

\
\ {{each arr}}\ 16)}} title="${display}"{{/if}}>${display}\ {{/each}}\
\ {{/enum}}\
\ {{else}}\
\ ×\
支持中文/英文输入

\
\
\
\ {{enum(key, item) data}}\ {{if key==="subCity"}}\
\ ${item.cnname}：{{if (item.data)}}{{each item.data}}${name}{{/each}}{{/if}}\
\ {{else}}\
    ${item.cnname}

\
\ {{if (item.data)}}\ {{each item.data}}\ ${name}\ {{/each}}\ {{/if}}\
\ {{/if}}\ {{/enum}}\
\ {{/if}}\ {{/if}}\ ', suggestionIpad: '\ {{if (d = $data.data)}}{{/if}}\
\
×

\
显示键盘
\ {{if !cQuery.isEmptyObject(d)}}\ {{enum(key,arr) d}}\
    ${key}

\
\ {{each(index, item) arr}}\ 16)}} title="${item.display}"{{/if}}>${item.display}\ {{/each}}\
\ {{/enum}}\ {{/if}}\
\ ', suggestionStyle: suggestionStyle, suggestionStyleIpad: suggestionStyle, filter: '\ {{if (sentBFI())}}{{/if}}\ {{if hasResult}}\ {{if group = InteMod.tmpl.groupKeyWordSource(list)}}{{/if}}\ {{if group.result.length}}\
\
\ ×\ {{tmpl InteMod.langConf.filterResult}}\

\ {{each (i, item) group.result}}\
\ \
${typeName}
\ \ {{tmpl InteMod.tmpl.HighLightAddressResult(left, val)}}\ {{if right}}({{tmpl InteMod.tmpl.HighLightAddressResult(right, val)}}){{/if}}\ \ \
\ {{/each}}\
\ {{/if}}\ {{if group.recom.length}}\
\
\ 为您展示更多城市下和{{tmpl InteMod.tmpl.getKeywordsVal()}}相关的结果\
\
\ {{each (i, item) group.recom}}\ \
${typeName}
\ \ {{tmpl InteMod.tmpl.HighLightAddressResult(left, val)}}\ ({{tmpl InteMod.tmpl.HighLightAddressResult(right, val)}})\ \ \ {{/each}}\
\ {{/if}}\ {{else}}\
\
\ ×{{tmpl InteMod.langConf.noFilterResult}}\

\
\ {{/if}}\ ', filterIpad: '\ {{if (sentBFI())}}{{/if}}\ {{if $data.hasResult}}\ {{if group = InteMod.tmpl.groupKeyWordSource($data.list)}}{{/if}}\ {{if group.result.length}}\
\
\ ×\ ${$data.val},若需缩小范围，请输入更多条件。\

\ {{each (i, item) group.result}}\
\ \
${item.typeName}
\ \ {{tmpl InteMod.tmpl.HighLightAddressResult(item.left, $data.val)}}\ {{if item.right}}({{tmpl InteMod.tmpl.HighLightAddressResult(item.right, $data.val)}}){{/if}}\ \ \
\ {{/each}}\
\ {{/if}}\ {{if group.recom.length}}\
\
\ 为您展示更多城市下和{{tmpl InteMod.tmpl.getKeywordsVal()}}相关的结果\
\
\ {{each (i, item) group.recom}}\ \
${item.typeName}
\ \ {{tmpl InteMod.tmpl.HighLightAddressResult(item.left, $data.val)}}\ ({{tmpl InteMod.tmpl.HighLightAddressResult(item.right, $data.val)}})\ \ \ {{/each}}\
\ {{/if}}\ {{else}}\
\
\ ×找不到：${$data.val}\

\
\ {{/if}}\ ', filterStyle: filterStyle, filterStyleIpad: filterStyle } }); InteMod.a_keyword.method('bind', 'change', function (mod, data) { CURRENTCITY.isAddressSelected = false; $('#inteHotelName').attr('_action', 'click'); $('#inteHotelName').attr('_selectType', data.items[5]); InteMod.tmpl.keywordFilterChange(data, $('#inteHotelName')); }); if (!($('#inteCityName').attr('tracked'))) { blurTrace('T', 'F', 'keyword'); } // InteMod.a_keyword.method('bind', 'userinput', function (mod, data) { if ($(this).attr('_lastvalue') != $(this).value()) { CURRENTCITY.isAddressSelected = false; } $('#inteHotelName').attr('_action', 'input'); $('#inteHotelName').attr('_selectType', ''); InteMod.tmpl.keywordFilterChange(data, $('#inteHotelName')); //var cityVal = this.value; var cityVal = data.autoCorrectValue; var cityId = $("#inteCityId").value(); var _userBehaviorKeyWordInfo = { "searchType": "S", "cityId": cityId, "keyword": cityVal }; //data.eventType === 'suggestionMousedown' 鼠标选择suggestion的数据 //data.eventType === 'filterMousedown' 鼠标选择filter的数据 //data.eventType === 'keydown' 键盘回车选择filter的数据 //evt.eventType === 'keydown' && isSelect 输入字符按回车（两次校验） //酒店搜索自动补全用户行为记录 if (data.eventType === 'suggestionMousedown') { _userBehaviorKeyWordInfo['searchType'] = "S_X"; //赋值到全局 win.userBehaviorKeyWordInfo = _userBehaviorKeyWordInfo; return; } //筛选 if (data.eventType === 'filterMousedown' || data.eventType === 'keydown') { _userBehaviorKeyWordInfo["searchType"] = "B+S"; _userBehaviorKeyWordInfo['Yindex'] = (data.target && $(data.target).attr("data-yindex")); _userBehaviorKeyWordInfo['inputkeyword'] = data.value; _userBehaviorKeyWordInfo['fulldata'] = data.data; //赋值到全局 win.userBehaviorKeyWordInfo = _userBehaviorKeyWordInfo; return; } }); // keyword.bind('keyup', function (e) { //由于现在埋点需要分别记录用户输入的内容和最终地址选择器选择的内容，所以需要在内存中保留一份用户输入的原始信息 $('#inteCityName').attr('tracked', ''); $('#inteHotelName').attr('rawInput', $('#inteHotelName').value()); if (e.keyCode == 13) { setTimeout(function () { $('#HI_Btn').trigger('click'); keyword[0].blur(); }, 0); } else { keyword.attr('url', ''); } }); } }, initNotice: function () { this.ops.city.length && (InteMod.n_city = this.ops.city.regMod("notice", PluginsVersion.notice, { name: "city", tips: InteMod.langConf.city_placeholder, selClass: "inputSel" })); this.ops.startDate.length && (InteMod.n_startDate = this.ops.startDate.regMod("notice", PluginsVersion.notice, { name: "startDate", tips: "yyyy-mm-dd", selClass: "inputSel" })); this.ops.endDate.length && (InteMod.n_endDate = this.ops.endDate.regMod("notice", PluginsVersion.notice, { name: "endDate", tips: "yyyy-mm-dd", selClass: "inputSel" })); //placeholder分流 if(!noticePlaceholderInstance){ this.ops.keyword.length && (InteMod.n_keyword = this.ops.keyword.regMod("notice", PluginsVersion.notice, { name: "keyword", tips: InteMod.langConf.keyword_placeholder, selClass: "inputSel" })); } else{ noticePlaceholderInstance.html5PlaceholderUse(); }; this.ops.checkInDate.length && (InteMod.n_checkInDate = this.ops.checkInDate.regMod("notice", PluginsVersion.notice, { name: "checkInDate", tips: "yyyy-mm-dd", selClass: "inputSel" })); this.ops.checkOutDate.length && (InteMod.n_checkOutDate = this.ops.checkOutDate.regMod("notice", PluginsVersion.notice, { name: "checkOutDate", tips: "yyyy-mm-dd", selClass: "inputSel" })); }, initCalendar: function (start, end) { var checkInInputInstance = start.regMod("calendar", PluginsVersion.calendar, { options: { showWeek: !0, container: cQuery.container, step:1 } }); var curDate = new Date(), lastValue = start.attr('lastvalue') ? start.attr('lastvalue') : start.value(), minDate = curDate.addDays(1) < lastValue.toDate() ? lastValue.toDate().addDays(1).toStdDateString() : curDate.addDays(1).toStdDateString(); var checkOutInputInstance = end.regMod("calendar", PluginsVersion.calendar, { options: { showWeek: !0, reference: '#' + start[0].id, minDate: minDate, step:1 } }); timeZone.getInstance(checkInInputInstance, checkOutInputInstance); //timeZone.initSetData(); start.bind('change', function (e) { e = e || win.event; var target = e.target || e.srcElement; var startDate = start.value().toDate(); if (startDate) { var nextDate = startDate.addDays(1); end.data('minDate', nextDate.toStdDateString()); //nextDate = nextDate.addDays(1); var endDate = end.value().toDate(); if (!endDate || endDate <= startDate) { end.value(nextDate.toFormatString('yyyy-MM-dd')); endDate = nextDate; end.getMod("notice", PluginsVersion.notice).method("checkValue"); end.getMod("calendar", PluginsVersion.calendar).method("setWeek", "#" + end[0].id); } if (endDate) { if (endDate - startDate > MAX_STAY) { setTimeout(function () { InteMod.formValidator.method("show", { $obj: end, data: InteMod.langConf['notice']['too_long'], removeErrorClass: !0, isScroll: false, iframe: true }) }.bind(this), 0); } } } else { end.removeData('minDate'); } }.bind(this)).bind('focus', function () { if (this.timer) { clearTimeout(this.timer); } }.bind(this)); end.bind('focus', function (e) { e = e || win.event; var target = e.target || e.srcElement; var startDate = start.value().toDate(); var endDate = target.value.toDate(); if (startDate && endDate && endDate - startDate > MAX_STAY) { setTimeout(function () { InteMod.formValidator.method("show", { $obj: end, data: InteMod.langConf['notice']['too_long'], removeErrorClass: !0, isScroll: false, iframe: true }) }.bind(this), 0); } }.bind(this)).bind('blur', function () { this.timer = setTimeout(function () { var startDate = start.value().toDate(); var endDate = end.value().toDate(); if (startDate && endDate && endDate > startDate) { if (endDate - startDate > MAX_STAY) { InteMod.formValidator.method("show", { $obj: end, data: InteMod.langConf['notice']['too_long'], removeErrorClass: !0, isScroll: false, iframe: true }) } } }.bind(this), 100); }.bind(this)); }, initFirstKeywordContent: function () { if (!this.ops.keyword.length) return; if(InteMod.n_keyword) InteMod.n_keyword.method('resetValue'); $('#inteHotelName').attr('url', ''); var param = { cityId: '', cityName: '', cityPY: '', checkIn: '', checkOut: '', isDomestic: '' }; getCookie(location.host.match(/big5\./) ? 'BIntHotelCityID' : 'IntHotelCityID', param); if (param.cityId) $('#inteCityId').value(param.cityId); if (param.checkIn) $('#inteCheckIn').value(param.checkIn); if (param.checkOut) $('#inteCheckOut').value(param.checkOut); }, initHistory: function () { var s = document.createElement('script'); s.src = window.intlEvnObj + '/international/tool/AjaxGetSearchHistory.aspx'; s.type = 'text/javascript'; document.getElementsByTagName('head')[0].appendChild(s); } }); function getCookie(mainKey, keyMap) { var m = cQuery.cookie.get(mainKey); m = (m ? m : "").split("split"); for (var i = 0, l = m.length; i < l; i++) { if (i == 0 && "cityId" in keyMap) keyMap["cityId"] = unescape(m[i]); else if (i == 1 && "cityName" in keyMap) keyMap["cityName"] = unescape(m[i]); else if (i == 2 && "cityPY" in keyMap) keyMap["cityPY"] = unescape(m[i]); else if (i == 3 && "checkIn" in keyMap) keyMap["checkIn"] = unescape(m[i]); else if (i == 4 && "checkOut" in keyMap) keyMap["checkOut"] = unescape(m[i]); else if (i == 5 && "isDomestic" in keyMap) keyMap["isDomestic"] = unescape(m[i]); } } function setCookie(keyMap) { var host = window.location.host; var cookiedomain = host.replace('www.', ''); var big5 = host.match(/big5\./); big5 && (cookiedomain = cookiedomain.replace('big5.', '')); cQuery.cookie.set(big5 ? 'BIntHotelCityID' : 'IntHotelCityID', null, keyMap["cityId"] + 'split' + keyMap["cityName"] + "split" + keyMap["cityPY"] + "split" + keyMap["checkIn"] + "split" + keyMap["checkOut"] + "split" + keyMap["isDomestic"], { expires: 30, domain: cookiedomain, path: '/' }); cQuery.cookie.set('DestinationType', null, window.DestinationType, { expires: 30, domain: cookiedomain, path: '/' }); } function clearCookie() { var host = window.location.host; var cookiedomain = host.replace('www.', ''); var big5 = host.match(/big5\./); big5 && (cookiedomain = cookiedomain.replace('big5.', '')); cQuery.cookie.del(big5 ? 'BIntHotelCityID' : 'IntHotelCityID'); } /** * BI需求，拼成固定字符串 * @param {String} 当前input值 * @param {String} 传给tracklog的值 */ function makeTrackLogVals(value, autoCorrect) { var v = '', isMatch = 0; if (autoCorrect) { //if autoCorrected, isMatch set to true isMatch = 1; v = autoCorrect; } else { isMatch = 0; v = value; } return 'key=' + v + '&isMatch=' + isMatch; } var HotelSearch = { showTips: function (obj, msg) { obj.focus(); setTimeout(function () { InteMod.formValidator.method('show', { $obj: $(obj), data: InteMod.langConf['notice'][msg], removeErrorClass: !0, hideEvent: 'blur', isScroll: false, iframe: true }); }, 50); return false; }, checkDate: function (date, v0) { v0 = v0 ? v0.toDate() : new Date().toStdDateString().toDate(); //海外时区 if($.v0){v0 = $.v0;}; var dt1 = date[0], dt2 = date[1], v1 = dt1.value.toDate() || 0, v2 = dt2.value.toDate() || 0, tips = this.showTips; return !$(dt1).value() ? tips(dt1, 'checkIn') : // checkIn date null !v1 ? tips(dt1, 'dateErr') : // checkIn date wrong v1 < v0 ? tips(dt1, 'too_early_in') : // checkIn date earlier than today !$(dt2).value() ? tips(dt2, 'checkOut') : // checkOut date null !v2 ? tips(dt2, 'dateErr') : //checkOut date wrong v1 >= v2 ? tips(dt2, 'too_early_out') : // checkOut date earliter than checkIn date v2 - v1 > MAX_STAY ? tips(dt2, 'too_long') : 1; // over maxDays }, submit: function () { var txtCityName = document.getElementById('inteCityName'); var txtCheckIn = document.getElementById('inteCheckIn'); var txtCheckOut = document.getElementById('inteCheckOut'); var txtKeyword = document.getElementById('inteHotelName'); var roomNum = $('#roomNum'); var childNum = $('#childNum'); var hidCityId = document.getElementById('inteCityId'); var hidCityPY = document.getElementById('inteCityPy'); var isMap = false; var cityValue = $(txtCityName).value(); if (!cityValue || cityValue.length == 1) { return this.showTips(txtCityName, 'city'); } if (this.checkDate([txtCheckIn, txtCheckOut])) { if (CURRENTCITY.isAddressSelected) { if (fm.__VIEWSTATE) fm.__VIEWSTATE.name = "NOVIEWSTATE"; var kurl = txtKeyword.getAttribute('url'); var link; var cityId = hidCityId.value || CURRENTCITY.id; var py = CURRENTCITY.py || hidCityPY.value; this.buildParam("StartDate", txtCheckIn.value, fm); this.buildParam("DepDate", txtCheckOut.value, fm); if(CURRENTCITY.type=="google"){ link = "/international/hotellist.aspx?GPlaceId="+cityId; }else{ link = CURRENTCITY.url.length > 0 ? (isMap ? CURRENTCITY.url.replace('international', 'international/maplist') : CURRENTCITY.url) : ((CURRENTCITY.isIntl ? '/international/' + (isMap ? 'maplist/' : '') : '/hotel/') + py + cityId + (kurl.length > 0 ? '/' + kurl : '')); } } else { if (fm.__VIEWSTATE) fm.__VIEWSTATE.name = "NOVIEWSTATE"; var other = []; var cityId = hidCityId.value || CURRENTCITY.id; var py = CURRENTCITY.py || hidCityPY.value; var kurl = txtKeyword.getAttribute('url'); var kval = txtKeyword.value.replace(/\+/g, '＋'); var ktype = txtKeyword.getAttribute('_type'); var ktypeId = txtKeyword.getAttribute('_typeId'); var hotelId = txtKeyword.getAttribute('_hotelId'); if (kval === InteMod.langConf.keyword_placeholder) { kval = ''; //txtKeyword.value = ''; } var link; other.push(encodeURIComponent(kurl ? kurl : (kval ? 'k2' + kval : ''))); if (!CURRENTCITY.isIntl) { this.buildParam("StartDate", txtCheckIn.value, fm); this.buildParam("DepDate", txtCheckOut.value, fm); py = py.toLowerCase(); //txtKeyword.value = ''; link = '/hotel/' + py + cityId + (other.length ? '/' + other.join('/') : ''); } else { var otherParam = '?CheckIn=' + txtCheckIn.value + '&CheckOut=' + txtCheckOut.value + '&Rooms=' + roomNum.value() + '&childNum=' + childNum.value(); if(ktype == 'hotel' || ktype == 'hotel_recom'){ link = '/international/' + hotelId + '.html' + otherParam + '&NoShowSearchBox=T'; } else{ //地标、机场、商圈、城市 if(ktype == 'landmark' || ktype == 'landmark_recom'|| ktype == 'railwaystation'|| ktype == 'railwaystation_recom'|| ktype == 'airport' || ktype == 'airport_recom'){ py = CURRENTCITY.py || hidCityPY.value; link = '/international/' + py + cityId + '/' + 's' + ktypeId; }else if(ktype== 'station'||ktype== 'station_recom'){ link = '/international/' + py + cityId + '/' + 'm' + ktypeId; }else if(ktype== 'brand'||ktype== 'brand_recom'){ link = '/international/' + py + cityId + '/' + 'h' + ktypeId; }else if(ktype== 'group'||ktype== 'group_recom'){ link = '/international/' + py + cityId + '/' + 'g' + ktypeId; }else if(ktype== 'metro'||ktype== 'metro_recom'){ link = '/international/' + py + cityId + '/' + 'sl' + ktypeId; } else if(ktype == 'zone' || ktype == 'zone_recom'){ py = CURRENTCITY.py || hidCityPY.value; link = '/international/' + py + cityId + '/' + 'zone' + ktypeId; } else if(ktype == 'city_recom'){ link = '/international/' + ktypeId; } else if(ktype == 'city'){ link = '/international/' + py + ktypeId; } else{ link = '/international/' + py + cityId + '/' + other; }; link = link + otherParam; }; } } fm.action = ENV + link; fm.target = '_self'; if (CURRENTCITY.isIntl && window.DestinationType ==1 ) { setCookie({ cityId: hidCityId.value, cityPY: escape(hidCityPY.value), cityName: escape(txtCityName.value), checkIn: txtCheckIn.value, checkOut: txtCheckOut.value, isDomestic: IsDomestic ? "T" : "F" }); } else { clearCookie(); }; return true; } else { return false } }, buildParam: function (name, value, form) { var el = form[name]; if (!el) { el = document.createElement('input'); el.type = 'hidden'; el.name = name; form.appendChild(el); } el.value = value; }, // convert yyyy-mm-dd to millisecond, cuz some browser(as safari, ie7 etc.) // not support new Date('yyyy-mm-dd') getMsec: function (str) { var arr = str.split('-'); return new Date(arr[0], arr[1], arr[2]).getTime(); }, todayDateStr: function () { var obj = new Date(); return obj.getFullYear() + '-' + (obj.getMonth() + 1) + '-' + obj.getDate(); }, tomorrowDateStr: function () { return this.todayDateStr().toDate().addDays(1).toFormatString('yyyy-MM-dd'); }, syncCookie: function () { var param = { cityId: '', cityName: '', cityPY: '', checkIn: '', checkOut: '' }; getCookie(location.host.match(/big5\./) ? 'BIntHotelCityID' : 'IntHotelCityID', param); var cityId = param.cityId; var cityPY = param.cityPY; var cityName = param.cityName; var checkIn = param.checkIn; var checkOut = param.checkOut; var DT = $.cookie.get('DestinationType'); if (DT) { window.DestinationType = DT; } if (cityId && cityPY && cityName) { $('#inteCityId').value(cityId); $('#inteCityName').value(cityName); $('#inteCityPy').value(cityPY); InteMod.n_city.method("checkValue"); } var today = this.todayDateStr(); var tomorrow = this.tomorrowDateStr(); if (checkIn && (this.getMsec(checkIn) > this.getMsec(today))) { $('#inteCheckIn').value(checkIn); } else { // 海外酒店日期默认是 14住 $('#inteCheckIn').value(today.toDate().addDays(14).toStdDateString()); } if (checkOut && (this.getMsec(checkOut) > this.getMsec(tomorrow))) { $('#inteCheckOut').value(checkOut); } else { // 海外酒店日期默认是 15离 $('#inteCheckOut').value(tomorrow.toDate().addDays(14).toStdDateString()); } InteMod.n_startDate.method("checkValue"); InteMod.n_endDate.method("checkValue"); }, init: function () { new RegMod({ city: $('#inteCityName'), startDate: $('#inteCheckIn'), endDate: $('#inteCheckOut'), keyword: $('#inteHotelName') }); if (window.DestinationType !=5){ this.syncCookie(); // 全站首页和海外频道通过COOKIE同步 } var hidCityId = document.getElementById('inteCityId'); var hidCityName = document.getElementById('inteCityName'); var isDomesticFilter = hidCityName.value.indexOf('中国') >= 0; if (window.DestinationType !=5){ setKeywordData({ itemId: hidCityId.value, isDomesitcFilter: isDomesticFilter, DestinationType: window.DestinationType}); } CURRENTCITY.isIntl = !isDomesticFilter; $('#HI_Btn').bind('click', function (e) { var thisDom = $(this), loadCls = "s_btn_ing"; thisDom.removeClass(loadCls); if (HotelSearch.submit()) { thisDom.addClass(loadCls); $('#HI_Btn').addClass('s_btn_ing'); $('#HI_Btn').value('搜索中…'); fm.submit(); } }); if ($isPad) { // iPad默认可输入 setTimeout(function () { txtKeyword[0].removeAttribute('readonly'); }, 3000); } } }; HotelSearch.init(); })(window, cQuery); function loadEvent() { if (!document.all) { window.constructor.prototype .__defineGetter__( "event", function () { var func = arguments.callee.caller; while (func != null) { var arg0 = func.arguments[0]; if (arg0 && (arg0.constructor == Event || arg0.constructor == MouseEvent)) { return arg0; } func = func.caller; } return null; }); } } function sentBFI() { if (typeof window['__bfi'] == 'undefined') window['__bfi'] = []; window.__bfi.push(['_tracklog', 'intlhotelkeyinput', 'keyword=' + $('#inteCityName').value() + '&location=' + $('#inteHotelName').value()]); } /** ** 坑爹的地址框新埋点, 在失焦以后进行埋点 ** @param {string} matchDest: 是否匹配目的地 ** @param {string} matchKeyword: 是否匹配关键词 ** @param {string}target: 本次触发的目标 **/ function blurTrace(matchDest, matchKeyword, target) { //由于blur有可能会触发2次的埋点，所以加个判断，本次操作只要埋过了就把tracked值置为true，用户不重新输入的话就不让再埋了 //目的地和关键词公用这个字段吧，不高兴判断两次了，如果有逻辑问题……你咬我啊 $('#inteCityName').attr('tracked', 'true'); var obj = {}; obj['destination'] = $('#inteCityName').value(); obj['destination_input'] = $('#inteCityName').attr('rawInput'); obj['keyword'] = $('#inteHotelName').value() + ($('#inteHotelName').attr('_selectType') ? ';' + $('#inteHotelName').attr('_selectType') : ''); obj['keyword_type'] = $('#inteHotelName').attr('_action'); obj['ismatch_dstn'] = matchDest; obj['ismatch_kyw'] = matchKeyword; obj['target'] = target; if (typeof window['__bfi'] == 'undefined') window['__bfi'] = []; window.__bfi.push(['_tracklog', 'ihtl_list_search_ismatch', $.stringifyJSON(obj)]); }/*****$endoflist$*****/